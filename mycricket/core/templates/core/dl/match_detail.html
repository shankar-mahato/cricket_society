{% extends 'core/dl/base.html' %}

{% block title %}{{ match }} - Match Details{% endblock %}

{% block page_title %}{{ match.team_a.name }} vs {{ match.team_b.name }}{% endblock %}

{% block extra_css %}
<style>
    .match-header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
    }
    .match-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }
    .match-teams {
        font-size: 20px;
        font-weight: 700;
        color: #2d3748;
    }
    .match-meta {
        display: flex;
        gap: 24px;
        color: #718096;
        font-size: 14px;
    }
    .match-meta span {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    /* Accordion Styles */
    .accordion-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        position: relative;
        z-index: 1;
    }
    .accordion-item {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }
    .accordion-header {
        padding: 20px 24px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .accordion-header:hover {
        background: #edf2f7;
    }
    .accordion-header.active {
        background: #4299e1;
        color: white;
    }
    .accordion-title {
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
    }
    .accordion-header.active .accordion-title {
        color: white;
    }
    .accordion-icon {
        font-size: 20px;
        transition: transform 0.3s;
        color: #718096;
    }
    .accordion-header.active .accordion-icon {
        color: white;
        transform: rotate(180deg);
    }
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .accordion-content.active {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
    }
    .accordion-body {
        padding: 24px;
    }
    
    /* Betting Interface Styles */
    .betting-market {
        margin-bottom: 24px;
        position: relative;
    }
    .betting-market:last-child {
        margin-bottom: 0;
    }
    .market-title {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
    }
    .runner-row {
        display: grid;
        grid-template-columns: 2fr 1fr 2fr;
        gap: 8px;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
        align-items: center;
    }
    .runner-row:last-child {
        border-bottom: none;
    }
    .runner-name {
        font-weight: 600;
        font-size: 16px;
        color: #2d3748;
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .stake-info {
        font-size: 14px;
        font-weight: 600;
        display: inline-block;
        margin-top: 4px;
    }
    .stake-info.lay-stake {
        color: #f56565;
    }
    .stake-info.back-stake {
        color: #48bb78;
    }
    .stake-info.hidden {
        display: none;
    }
    .odds-cell {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .odds-value {
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        padding: 8px;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .odds-back {
        color: #ffffff;
        background: #48bb78;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 700;
        min-width: 50px;
        display: inline-block;
        text-align: center;
    }
    .odds-lay {
        color: #ffffff;
        background: #f56565;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 700;
        min-width: 50px;
        display: inline-block;
        text-align: center;
    }
    .bet-buttons {
        display: flex;
        gap: 8px;
    }
    .bet-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        position: relative;
    }
    .bet-btn.back {
        background: #48bb78;
        color: white;
    }
    .bet-btn.back:hover {
        background: #38a169;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
    }
    .bet-btn.lay {
        background: #f56565;
        color: white;
    }
    .bet-btn.lay:hover {
        background: #e53e3e;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3);
    }
    .bet-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .header-row {
        grid-template-columns: 2fr 1fr 2fr !important;
        margin-bottom: 8px;
        padding: 8px 0;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #718096;
        font-size: 12px;
        text-transform: uppercase;
    }
    
    .session-details {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #e2e8f0;
    }
    .session-details .market-title {
        margin-bottom: 16px;
    }
    .session-detail-row {
        display: grid;
        grid-template-columns: 2fr 1fr 2fr;
        gap: 8px;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
        align-items: center;
    }
    .session-detail-row:last-child {
        border-bottom: none;
    }
    .session-detail-label {
        font-weight: 500;
        color: #4a5568;
        padding: 8px 0;
    }
    
    /* Total Points */
    .total-points-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
    .points-card {
        background: #f7fafc;
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        border: 1px solid #e2e8f0;
    }
    .points-label {
        font-size: 14px;
        color: #718096;
        margin-bottom: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .points-value {
        font-size: 32px;
        font-weight: 700;
        color: #2d3748;
    }
    
    /* Table Styles */
    .table-container {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        overflow: visible;
        border: none;
    }
    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    thead {
        background: #f7fafc;
    }
    th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: #2d3748;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
    }
    td {
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 14px;
    }
    tbody tr:hover {
        background: #f7fafc;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .match-header {
            padding: 20px;
        }
        .match-info {
            flex-direction: column;
            align-items: flex-start;
        }
        .match-teams {
            font-size: 18px;
        }
        .match-meta {
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        .accordion-header {
            padding: 16px 20px;
        }
        .accordion-title {
            font-size: 16px;
        }
        .accordion-body {
            padding: 20px;
        }
        .runner-row {
            grid-template-columns: 2fr 1fr 2fr;
            gap: 8px;
            padding: 12px 0;
        }
        .runner-name {
            font-size: 15px;
        }
        .stake-info {
            font-size: 13px;
            margin-top: 3px;
            gap: 4px;
        }
        .stake-control-icon {
            width: 18px;
            height: 18px;
            font-size: 14px;
        }
        .odds-value {
            font-size: 16px;
            white-space: nowrap;
        }
        .odds-back {
            color: #ffffff;
            background: #48bb78;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .odds-lay {
            color: #ffffff;
            background: #f56565;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .bet-btn {
            padding: 10px 12px;
            font-size: 13px;
        }
        .session-detail-row {
            grid-template-columns: 2fr 1fr 2fr;
            gap: 8px;
            padding: 12px 0;
        }
        .total-points-grid {
            grid-template-columns: 1fr;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            min-width: 700px;
        }
        th, td {
            padding: 12px 16px;
            font-size: 13px;
        }
    }
    
    @media (max-width: 480px) {
        .match-header {
            padding: 16px;
        }
        .accordion-header {
            padding: 14px 16px;
        }
        .accordion-title {
            font-size: 15px;
        }
        .accordion-body {
            padding: 16px;
        }
        .runner-row {
            grid-template-columns: 2fr 1fr 2fr;
            padding: 10px 0;
        }
        .session-detail-row {
            grid-template-columns: 2fr 1fr 2fr;
            padding: 10px 0;
        }
        .odds-value {
            font-size: 14px;
            white-space: nowrap;
        }
        .odds-back {
            color: #ffffff;
            background: #48bb78;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .odds-lay {
            color: #ffffff;
            background: #f56565;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .bet-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .runner-name, .session-detail-label {
            font-size: 14px;
        }
        .stake-info {
            font-size: 12px;
            margin-top: 2px;
        }
        table {
            min-width: 600px;
        }
        th, td {
            padding: 10px 12px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Match Header -->
<div class="match-header" data-match-id="{{ match.id }}">
    <div class="match-info">
        <div class="match-teams">{{ match.team_a.name }} vs {{ match.team_b.name }}</div>
        <div class="match-meta">
            <span>üìç {{ match.venue|default:"TBA" }}</span>
            <span>üìÖ {{ match.match_date|date:"M d, Y H:i" }}</span>
            <span>‚ö° {{ match.get_status_display }}</span>
        </div>
    </div>
</div>

<!-- Accordion Container -->
<div class="accordion-container">
    <!-- Match Odds Accordion -->
    <div class="accordion-item">
        <div class="accordion-header active" onclick="toggleAccordion('match-odds')">
            <span class="accordion-title">Match Odds</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="match-odds" class="accordion-content active">
            <div class="accordion-body">
                <!-- Runner Section -->
                <div class="betting-market">
                    <div class="market-title">Runner</div>
                    <div class="runner-row header-row">
                        <div>TEAM</div>
                        <div style="text-align: center;">ODDS</div>
                        <div style="text-align: center;">ACTION</div>
                    </div>
                    {% for odds in match_odds %}
                    <div class="runner-row" data-runner="{{ odds.runner }}" data-back-odds="{{ odds.back_odds }}" data-lay-odds="{{ odds.lay_odds }}">
                        <div class="runner-name">
                            {{ odds.runner }}
                            <span class="stake-info hidden" id="stake-{{ forloop.counter0 }}"></span>
                        </div>
                        <div class="odds-cell">
                            <div class="odds-value">
                                <span class="odds-back">{{ odds.back_odds }}</span> / <span class="odds-lay">{{ odds.lay_odds }}</span>
                            </div>
                        </div>
                        <div class="bet-buttons">
                            <button class="bet-btn back" onclick="event.stopPropagation(); placeBet('{{ odds.runner }}', 'back', '{{ odds.back_odds }}');">Back</button>
                            <button class="bet-btn lay" onclick="event.stopPropagation(); placeBet('{{ odds.runner }}', 'lay', '{{ odds.lay_odds }}');">Lay</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Session Details Section -->
                <div class="session-details">
                    <div class="market-title">Session Details</div>
                    <div class="session-detail-row header-row">
                        <div>SESSION</div>
                        <div style="text-align: center;">ODDS</div>
                        <div style="text-align: center;">ACTION</div>
                    </div>
                    {% for detail in session_details %}
                    <div class="session-detail-row">
                        <div class="session-detail-label">{{ detail.label }}</div>
                        <div class="odds-cell">
                            <div class="odds-value">
                                <span class="odds-back">{{ detail.not }}</span> / <span class="odds-lay">{{ detail.yes }}</span>
                            </div>
                        </div>
                        <div class="bet-buttons">
                            <button class="bet-btn back" onclick="event.stopPropagation(); placeBet('{{ detail.label }}', 'not', '{{ detail.not }}');">Not</button>
                            <button class="bet-btn lay" onclick="event.stopPropagation(); placeBet('{{ detail.label }}', 'yes', '{{ detail.yes }}');">Yes</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Points Accordion -->
    <div class="accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('total-points')">
            <span class="accordion-title">Total Points</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="total-points" class="accordion-content">
            <div class="accordion-body">
                <div class="total-points-grid">
                    <div class="points-card">
                        <div class="points-label">{{ match.team_a.name }}</div>
                        <div class="points-value">{{ total_points.team1 }}</div>
                    </div>
                    <div class="points-card">
                        <div class="points-label">{{ match.team_b.name }}</div>
                        <div class="points-value">{{ total_points.team2 }}</div>
                    </div>
                    <div class="points-card">
                        <div class="points-label">Drawn</div>
                        <div class="points-value">{{ total_points.drawn }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Match Bet Accordion -->
    <div class="accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('match-bet')">
            <span class="accordion-title">Match Bet</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="match-bet" class="accordion-content">
            <div class="accordion-body">
                <div class="table-container">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sr.</th>
                                    <th>User</th>
                                    <th>Odds</th>
                                    <th>Stake</th>
                                    <th>Bettype</th>
                                    <th>Team</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if match_bets %}
                                    {% for bet in match_bets %}
                                    <tr>
                                        <td>{{ bet.sr }}</td>
                                        <td>{{ bet.user }}</td>
                                        <td>{{ bet.odds }}</td>
                                        <td>‚Çπ{{ bet.stake|floatformat:2 }}</td>
                                        <td>{{ bet.bettype }}</td>
                                        <td>{{ bet.team }}</td>
                                        <td>{{ bet.data }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="empty-state">No match bets found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Session Accordion -->
    <div class="accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('session')">
            <span class="accordion-title">Session</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="session" class="accordion-content">
            <div class="accordion-body">
                <div class="table-container">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sr.</th>
                                    <th>User</th>
                                    <th>Odds</th>
                                    <th>Stake</th>
                                    <th>Bettype</th>
                                    <th>Team</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if session_data %}
                                    {% for session in session_data %}
                                    <tr>
                                        <td>{{ session.sr }}</td>
                                        <td>{{ session.user }}</td>
                                        <td>{{ session.odds }}</td>
                                        <td>‚Çπ{{ session.stake|floatformat:2 }}</td>
                                        <td>{{ session.bettype }}</td>
                                        <td>{{ session.team }}</td>
                                        <td>{{ session.data }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="empty-state">No session data found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleAccordion(id) {
    const content = document.getElementById(id);
    const header = content.previousElementSibling;
    
    // Toggle active class
    content.classList.toggle('active');
    header.classList.toggle('active');
}

let currentBetData = null;

function placeBet(selection, type, odds) {
    // Always allow clicking - just update modal with new selection
    openBetModal(selection, type, odds);
}

function openBetModal(selection, type, odds) {
    currentBetData = {
        selection: selection,
        type: type,
        odds: parseFloat(odds)
    };
    
    // Update modal content
    const modalTitle = document.getElementById('betModalTitle');
    const modalHeader = document.querySelector('.bet-modal-header');
    const oddsBtns = document.querySelectorAll('.odds-btn');
    const stakeBtns = document.querySelectorAll('.quick-stake-btn');
    const inputLabels = document.querySelectorAll('.bet-input-label');
    
    modalTitle.textContent = type.toUpperCase();
    modalHeader.className = 'bet-modal-header ' + type.toLowerCase() + '-header';
    
    // Update label colors
    inputLabels.forEach(label => {
        label.className = 'bet-input-label ' + type.toLowerCase() + '-label';
    });
    
    // Update odds button colors
    oddsBtns.forEach(btn => {
        btn.className = 'odds-btn ' + type.toLowerCase() + '-btn';
        if (btn.textContent === '-') {
            btn.classList.add('minus');
        } else {
            btn.classList.add('plus');
        }
    });
    
    // Update quick stake button colors
    stakeBtns.forEach(btn => {
        btn.className = 'quick-stake-btn ' + type.toLowerCase() + '-stake';
    });
    
    document.getElementById('betSelection').textContent = selection;
    document.getElementById('betOdds').value = odds;
    document.getElementById('betAmount').value = '';
    document.querySelector('.stake-display').textContent = '0';
    
    // Show modal at bottom
    const modal = document.getElementById('betModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Initialize stake input listener
    initStakeInput();
    
    // Update stake info display below team names (will show when stake is entered)
    // Note: updateStakeInfo will be called when stake amount changes
    
    // Focus on stake input
    setTimeout(() => {
        document.getElementById('betAmount').focus();
    }, 100);
}

function adjustOdds(change) {
    const oddsInput = document.getElementById('betOdds');
    let currentOdds = parseFloat(oddsInput.value) || 1.01;
    let newOdds = currentOdds + change;
    
    // Ensure minimum odds of 1.01
    if (newOdds < 1.01) {
        newOdds = 1.01;
    }
    
    // Round to 2 decimal places
    newOdds = Math.round(newOdds * 100) / 100;
    oddsInput.value = newOdds.toFixed(2);
    
    if (currentBetData) {
        currentBetData.odds = newOdds;
        const stakeInput = document.getElementById('betAmount');
        const stakeAmount = parseFloat(stakeInput ? stakeInput.value : 0) || 0;
        if (stakeAmount > 0) {
            updateStakeInfo(currentBetData.selection, currentBetData.type, newOdds, stakeAmount);
        }
    }
}

function addStake(amount) {
    const stakeInput = document.getElementById('betAmount');
    const currentStake = parseFloat(stakeInput.value) || 0;
    const newStake = currentStake + amount;
    stakeInput.value = newStake;
    updateStakeDisplay(newStake);
    
    // Update stake info below team names
    if (currentBetData) {
        updateStakeInfo(currentBetData.selection, currentBetData.type, currentBetData.odds, newStake);
    }
}

function updateStakeDisplay(amount) {
    document.querySelector('.stake-display').textContent = amount || '0';
}

// Update stake display on input change (will be initialized when modal opens)
function initStakeInput() {
    const stakeInput = document.getElementById('betAmount');
    if (stakeInput) {
        // Remove existing listener if any
        stakeInput.removeEventListener('input', handleStakeInput);
        stakeInput.addEventListener('input', handleStakeInput);
    }
}

function handleStakeInput() {
    const stake = parseFloat(this.value) || 0;
    updateStakeDisplay(stake);
    
    // Update stake info below team names when stake changes
    if (currentBetData) {
        updateStakeInfo(currentBetData.selection, currentBetData.type, currentBetData.odds, stake);
    }
}

// Store stake data for each runner row
let stakeDataMap = {};

// Get match ID from the page (we'll need to add a data attribute or use match.id if available)
function getMatchId() {
    // Try to get from a data attribute or URL
    const matchHeader = document.querySelector('.match-header');
    if (matchHeader && matchHeader.dataset.matchId) {
        return matchHeader.dataset.matchId;
    }
    // Fallback: try to extract from URL
    const pathParts = window.location.pathname.split('/');
    const matchIdIndex = pathParts.indexOf('match') + 1;
    return matchIdIndex > 0 ? pathParts[matchIdIndex] : null;
}

// Load persisted stake data from localStorage
function loadStakeData() {
    const matchId = getMatchId();
    if (!matchId) return;
    
    const key = `match_${matchId}_stakes`;
    const savedData = localStorage.getItem(key);
    if (savedData) {
        try {
            stakeDataMap = JSON.parse(savedData);
            // Restore display for all saved stakes
            Object.keys(stakeDataMap).forEach(index => {
                const data = stakeDataMap[index];
                updateStakeDisplayFromData(parseInt(index), data);
            });
        } catch (e) {
            console.error('Error loading stake data:', e);
        }
    }
}

// Save stake data to localStorage
function saveStakeData() {
    const matchId = getMatchId();
    if (!matchId) return;
    
    const key = `match_${matchId}_stakes`;
    localStorage.setItem(key, JSON.stringify(stakeDataMap));
}

// Update stake display from saved data
function updateStakeDisplayFromData(rowIndex, data) {
    const runnerRows = document.querySelectorAll('.runner-row[data-runner]');
    if (rowIndex >= runnerRows.length) return;
    
    const row = runnerRows[rowIndex];
    const stakeElement = row.querySelector('.stake-info');
    if (!stakeElement) return;
    
    // Create the display text
    const displayText = data.value > 0 ? `+${data.value}` : `${data.value}`;
    stakeElement.textContent = displayText;
    stakeElement.className = `stake-info ${data.type === 'lay' || data.type === 'yes' ? 'lay-stake' : 'back-stake'}`;
    stakeElement.classList.remove('hidden');
}

function updateStakeInfo(selection, type, odds, stakeAmount = null) {
    // Get stake amount from input if not provided
    if (stakeAmount === null) {
        const stakeInput = document.getElementById('betAmount');
        stakeAmount = parseFloat(stakeInput ? stakeInput.value : 0) || 0;
    }
    
    if (stakeAmount <= 0) {
        return;
    }
    
    // Find all runner rows
    const runnerRows = document.querySelectorAll('.runner-row[data-runner]');
    let selectedRow = null;
    let otherRow = null;
    let selectedIndex = -1;
    let otherIndex = -1;
    
    runnerRows.forEach((row, index) => {
        if (row.getAttribute('data-runner') === selection) {
            selectedRow = row;
            selectedIndex = index;
        } else {
            otherRow = row;
            otherIndex = index;
        }
    });
    
    if (!selectedRow || !otherRow) return;
    
    // Get odds for both teams
    const selectedLayOdds = parseFloat(selectedRow.getAttribute('data-lay-odds'));
    const selectedBackOdds = parseFloat(selectedRow.getAttribute('data-back-odds'));
    const otherLayOdds = parseFloat(otherRow.getAttribute('data-lay-odds'));
    const otherBackOdds = parseFloat(otherRow.getAttribute('data-back-odds'));
    
    // Calculate stake display values based on type
    if (type === 'lay' || type === 'yes') {
        // For lay: show stake amount in red for selected team (what you receive/lose)
        // For other team: show stake amount in green (profit if selected team loses)
        const selectedStakeElement = selectedRow.querySelector('.stake-info');
        const otherStakeElement = otherRow.querySelector('.stake-info');
        
        // Based on user example: lay at 1.95 with stake 100 shows "90" in red
        // This appears to be: stake - (lay_odds - back_odds) * stake
        // Or simplified: stake * (1 - (lay_odds - back_odds))
        // For 1.90/1.95 with stake 100: 100 * (1 - 0.05) = 95... still not 90
        
        // Let me try: stake - (lay_odds - 1) * stake / 10 = 100 - 95/10 = 90.5 ‚âà 90
        // Or: stake * back_odds / lay_odds * 100 = 100 * 1.90 / 1.95 * 100 = 9743... no
        
        // Actually, maybe it's: stake * (back_odds - 1) = 100 * 0.90 = 90! That matches!
        // So for lay, show: stake * (back_odds - 1) in red
        let selectedValue = Math.round(stakeAmount * (selectedBackOdds - 1));
        let otherValue = Math.round(stakeAmount);
        
        // If there are existing stakes, add/subtract accordingly
        if (existingSelectedData) {
            selectedValue = existingSelectedData.value + selectedValue;
        }
        if (existingOtherData) {
            otherValue = existingOtherData.value + otherValue;
        }
        
        if (selectedStakeElement) {
            // Format: +value or -value as text
            const displayText = selectedValue > 0 ? `+${selectedValue}` : `${selectedValue}`;
            selectedStakeElement.textContent = displayText;
            selectedStakeElement.className = 'stake-info lay-stake';
            selectedStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingAmount = existingSelectedData ? existingSelectedData.stakeAmount : 0;
            stakeDataMap[selectedIndex] = {
                selection: selection,
                type: type,
                odds: odds,
                stakeAmount: existingAmount + stakeAmount,
                value: selectedValue
            };
        }
        
        if (otherStakeElement) {
            // Format: +value or -value as text
            const displayText = otherValue > 0 ? `+${otherValue}` : `${otherValue}`;
            otherStakeElement.textContent = displayText;
            otherStakeElement.className = 'stake-info back-stake';
            otherStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingOtherAmount = existingOtherData ? existingOtherData.stakeAmount : 0;
            stakeDataMap[otherIndex] = {
                selection: otherRow.getAttribute('data-runner'),
                type: 'back',
                odds: otherBackOdds,
                stakeAmount: existingOtherAmount + stakeAmount,
                value: otherValue
            };
        }
        
        // Save to localStorage
        saveStakeData();
    } else if (type === 'back' || type === 'not') {
        // For back: show profit (what you win) in green for selected team
        // For other team: show stake amount in red (liability)
        const selectedStakeElement = selectedRow.querySelector('.stake-info');
        const otherStakeElement = otherRow.querySelector('.stake-info');
        
        // Profit for back: (odds - 1) * stake
        let profit = Math.round((selectedBackOdds - 1) * stakeAmount);
        let liability = Math.round(stakeAmount);
        
        // If there are existing stakes, add/subtract accordingly
        if (existingSelectedData) {
            profit = existingSelectedData.value + profit;
        }
        if (existingOtherData) {
            liability = existingOtherData.value + liability;
        }
        
        if (selectedStakeElement) {
            // Format: +value or -value as text
            const displayText = profit > 0 ? `+${profit}` : `${profit}`;
            selectedStakeElement.textContent = displayText;
            selectedStakeElement.className = 'stake-info back-stake';
            selectedStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingAmount = existingSelectedData ? existingSelectedData.stakeAmount : 0;
            stakeDataMap[selectedIndex] = {
                selection: selection,
                type: type,
                odds: odds,
                stakeAmount: existingAmount + stakeAmount,
                value: profit
            };
        }
        
        if (otherStakeElement) {
            // Format: +value or -value as text
            const displayText = liability > 0 ? `+${liability}` : `${liability}`;
            otherStakeElement.textContent = displayText;
            otherStakeElement.className = 'stake-info lay-stake';
            otherStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingOtherAmount = existingOtherData ? existingOtherData.stakeAmount : 0;
            stakeDataMap[otherIndex] = {
                selection: otherRow.getAttribute('data-runner'),
                type: 'lay',
                odds: otherLayOdds,
                stakeAmount: existingOtherAmount + stakeAmount,
                value: liability
            };
        }
        
        // Save to localStorage
        saveStakeData();
    }
}

function adjustStakeFromRow(rowIndex, change) {
    event.stopPropagation();
    const stakeData = stakeDataMap[rowIndex];
    if (!stakeData) return;
    
    // Calculate new stake amount based on the stored data
    const newStakeAmount = Math.max(100, stakeData.stakeAmount + change);
    
    // Update the stake info with new amount
    updateStakeInfo(stakeData.selection, stakeData.type, stakeData.odds, newStakeAmount);
    
    // If modal is open, update the stake input
    const modal = document.getElementById('betModal');
    if (modal && modal.classList.contains('show')) {
        const stakeInput = document.getElementById('betAmount');
        if (stakeInput) {
            stakeInput.value = newStakeAmount;
            updateStakeDisplay(newStakeAmount);
        }
    }
}

function closeBetModal() {
    const modal = document.getElementById('betModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    currentBetData = null;
    
    // Keep stake info visible after modal closes - don't hide it
}

function submitBet() {
    const amountInput = document.getElementById('betAmount');
    const amount = parseFloat(amountInput.value);
    const odds = parseFloat(document.getElementById('betOdds').value);
    
    if (!amount || amount < 100) {
        alert('Please enter a valid amount (minimum ‚Çπ100)');
        return;
    }
    
    if (!currentBetData) {
        return;
    }
    
    // Update current bet data with latest odds
    currentBetData.odds = odds;
    
    // Place bet directly - close modal without confirmation
    console.log('Placing bet:', {
        selection: currentBetData.selection,
        type: currentBetData.type,
        odds: odds,
        amount: amount
    });
    
    // TODO: Integrate with backend API when ready
    // For now, just close the modal
    closeBetModal();
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBetModal();
    }
});

// Load stake data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadStakeData();
});
</script>

<!-- Bet Modal -->
<div id="betModal" class="bet-modal">
    <div class="bet-modal-overlay" onclick="closeBetModal()"></div>
    <div class="bet-modal-content">
        <div class="bet-modal-header lay-header">
            <h3 id="betModalTitle" class="bet-type-header">LAY</h3>
        </div>
        <div class="bet-modal-body">
            <div class="bet-selection-info">
                <div class="bet-team-name" id="betSelection"></div>
            </div>
            
            <div class="bet-input-section">
                <div class="bet-input-row">
                    <div class="bet-input-label">Odds</div>
                    <div class="odds-control">
                        <button class="odds-btn minus" onclick="adjustOdds(-0.01)">-</button>
                        <input type="number" id="betOdds" step="0.01" min="1.01" value="1.01" class="odds-input" readonly>
                        <button class="odds-btn plus" onclick="adjustOdds(0.01)">+</button>
                    </div>
                </div>
                
                <div class="bet-input-row">
                    <div class="bet-input-label">Stake</div>
                    <div class="stake-control">
                        <input type="number" id="betAmount" min="100" step="100" placeholder="0" class="stake-input" autofocus>
                        <span class="stake-display">0</span>
                    </div>
                </div>
            </div>
            
            <div class="quick-stake-buttons">
                <button class="quick-stake-btn" onclick="addStake(1000)">+1000</button>
                <button class="quick-stake-btn" onclick="addStake(5000)">+5000</button>
                <button class="quick-stake-btn" onclick="addStake(10000)">+10000</button>
                <button class="quick-stake-btn" onclick="addStake(25000)">+25000</button>
                <button class="quick-stake-btn" onclick="addStake(50000)">+50000</button>
                <button class="quick-stake-btn" onclick="addStake(100000)">+100000</button>
            </div>
            
            <div class="bet-modal-actions">
                <button class="bet-cancel-btn" onclick="closeBetModal()">CANCEL</button>
                <button class="bet-submit-btn" onclick="submitBet()">PLACE BET</button>
            </div>
        </div>
    </div>
</div>

<style>
    .bet-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: none;
    }
    .bet-modal.show {
        display: flex !important;
        align-items: flex-end;
        justify-content: center;
    }
    .bet-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        pointer-events: auto;
    }
    .bet-modal-content {
        position: relative;
        background: white;
        border-radius: 12px 12px 0 0;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        z-index: 10001;
        animation: slideUpFromBottom 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
    }
    @keyframes slideUpFromBottom {
        from {
            transform: translateY(100%);
        }
        to {
            transform: translateY(0);
        }
    }
    .bet-modal-header {
        padding: 16px 20px;
        color: white;
    }
    .bet-modal-header.back-header {
        background: #4299e1;
    }
    .bet-modal-header.lay-header {
        background: #ec4899;
    }
    .bet-type-header {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .bet-input-label.back-label {
        color: #4299e1;
    }
    .bet-input-label.lay-label {
        color: #ec4899;
    }
    .odds-btn.back-btn {
        border-color: #4299e1;
        color: #4299e1;
    }
    .odds-btn.back-btn:hover {
        background: #4299e1;
        color: white;
    }
    .odds-btn.lay-btn {
        border-color: #ec4899;
        color: #ec4899;
    }
    .odds-btn.lay-btn:hover {
        background: #ec4899;
        color: white;
    }
    .quick-stake-btn.back-stake {
        background: #4299e1;
    }
    .quick-stake-btn.back-stake:hover {
        background: #3182ce;
    }
    .quick-stake-btn.lay-stake {
        background: #ec4899;
    }
    .quick-stake-btn.lay-stake:hover {
        background: #db2777;
    }
    .bet-modal-body {
        padding: 20px;
    }
    .bet-selection-info {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e2e8f0;
    }
    .bet-team-name {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
    }
    .bet-input-section {
        margin-bottom: 20px;
    }
    .bet-input-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .bet-input-label {
        font-weight: 600;
        color: #ec4899;
        font-size: 16px;
        text-transform: uppercase;
    }
    .odds-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .odds-btn {
        width: 36px;
        height: 36px;
        border: 2px solid #ec4899;
        background: white;
        color: #ec4899;
        border-radius: 6px;
        font-size: 20px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .odds-btn:hover {
        background: #ec4899;
        color: white;
    }
    .odds-input {
        width: 80px;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        background: #f7fafc;
        color: #2d3748;
    }
    .stake-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .stake-input {
        width: 120px;
        padding: 10px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        text-align: center;
        transition: all 0.2s;
    }
    .stake-input:focus {
        outline: none;
        border-color: #ec4899;
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }
    .stake-display {
        font-size: 16px;
        color: #718096;
        min-width: 40px;
    }
    .quick-stake-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 24px;
    }
    .quick-stake-btn {
        padding: 12px 8px;
        border: none;
        border-radius: 6px;
        background: #ec4899;
        color: white;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .quick-stake-btn:hover {
        background: #db2777;
        transform: translateY(-1px);
    }
    .bet-modal-actions {
        display: flex;
        gap: 12px;
    }
    .bet-submit-btn, .bet-cancel-btn {
        flex: 1;
        padding: 16px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
    }
    .bet-submit-btn {
        background: #48bb78;
        color: white;
    }
    .bet-submit-btn:hover {
        background: #38a169;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
    }
    .bet-cancel-btn {
        background: #f56565;
        color: white;
    }
    .bet-cancel-btn:hover {
        background: #e53e3e;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3);
    }
    
    @media (max-width: 480px) {
        .bet-modal-content {
            max-height: 95vh;
        }
        .bet-modal-header {
            padding: 14px 16px;
        }
        .bet-modal-body {
            padding: 16px;
        }
        .quick-stake-buttons {
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .quick-stake-btn {
            padding: 10px 6px;
            font-size: 12px;
        }
        .bet-submit-btn, .bet-cancel-btn {
            padding: 14px 16px;
            font-size: 14px;
        }
    }
</style>
{% endblock %}
