{% extends 'core/dl/base.html' %}

{% block title %}{{ match }} - Match Details{% endblock %}

{% block page_title %}{{ match.team_a.name }} vs {{ match.team_b.name }}{% endblock %}

{% block extra_css %}
<style>
    .match-header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 24px;
        border: 1px solid #e2e8f0;
    }
    .match-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
    }
    .match-teams {
        font-size: 20px;
        font-weight: 700;
        color: #2d3748;
    }
    .match-meta {
        display: flex;
        gap: 24px;
        color: #718096;
        font-size: 14px;
    }
    .match-meta span {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    /* Accordion Styles */
    .accordion-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        position: relative;
        z-index: 1;
    }
    .accordion-item {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
        overflow: hidden;
    }
    .accordion-header {
        padding: 20px 24px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
    }
    .accordion-header:hover {
        background: #edf2f7;
    }
    .accordion-header.active {
        background: #4299e1;
        color: white;
    }
    .accordion-title {
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
    }
    .accordion-header.active .accordion-title {
        color: white;
    }
    .accordion-icon {
        font-size: 20px;
        transition: transform 0.3s;
        color: #718096;
    }
    .accordion-header.active .accordion-icon {
        color: white;
        transform: rotate(180deg);
    }
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .accordion-content.active {
        max-height: 5000px;
        transition: max-height 0.5s ease-in;
    }
    .accordion-body {
        padding: 24px;
    }
    
    /* Betting Interface Styles */
    .betting-market {
        margin-bottom: 24px;
        position: relative;
    }
    .betting-market:last-child {
        margin-bottom: 0;
    }
    .market-title {
        font-size: 16px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
    }
    .runner-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 8px;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
        align-items: center;
    }
    .runner-row:last-child {
        border-bottom: none;
    }
    .runner-name {
        font-weight: 600;
        font-size: 16px;
        color: #2d3748;
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .stake-info {
        font-size: 14px;
        font-weight: 600;
        display: block;
        margin-top: 4px;
        line-height: 1.4;
    }
    .stake-info.lay-stake {
        color: #f56565;
    }
    .stake-info.back-stake {
        color: #48bb78;
    }
    .stake-info.hidden {
        display: none;
    }
    .balance-display {
        font-size: 14px;
        font-weight: 700;
        margin-top: 4px;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
    }
    .balance-display.balance-positive {
        color: #48bb78;
        background: #c6f6d5;
    }
    .balance-display.balance-negative {
        color: #f56565;
        background: #fed7d7;
    }
    .balance-display.hidden {
        display: none;
    }
    .odds-cell-wrapper {
        position: relative;
    }
    .odds-cell {
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
        padding: 8px;
        transition: opacity 0.2s;
    }
    .odds-cell:hover {
        opacity: 0.8;
    }
    .bet-dropdown {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 320px;
        max-width: 400px;
        margin-top: 8px;
        display: none !important;
        visibility: hidden;
        opacity: 0;
        border: 1px solid #e2e8f0;
    }
    .bet-dropdown.show {
        display: flex !important;
        visibility: visible;
        opacity: 1;
        animation: slideDown 0.2s ease-out;
    }
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
    .bet-dropdown-header {
        padding: 12px 16px;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        font-size: 14px;
        position: relative;
        z-index: 1;
        flex-shrink: 0;
    }
    .bet-dropdown-header.back-header {
        background: #4299e1;
    }
    .bet-dropdown-header.lay-header {
        background: #ec4899;
    }
    .close-dropdown {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
        z-index: 10001;
        position: relative;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    .close-dropdown:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    .close-dropdown:active {
        background: rgba(255, 255, 255, 0.4);
    }
    .bet-dropdown-body {
        padding: 16px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
    .bet-dropdown-actions {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        flex-shrink: 0;
    }
    .bet-submit-btn, .bet-cancel-btn {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        position: relative;
        z-index: 1;
    }
    .odds-value {
        font-size: 18px;
        font-weight: 700;
        text-align: center;
        padding: 8px;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .odds-back {
        color: #ffffff;
        background: #48bb78;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 700;
        min-width: 50px;
        display: inline-block;
        text-align: center;
    }
    .odds-lay {
        color: #ffffff;
        background: #f56565;
        padding: 6px 10px;
        border-radius: 6px;
        font-weight: 700;
        min-width: 50px;
        display: inline-block;
        text-align: center;
    }
    .bet-buttons {
        display: flex;
        gap: 8px;
    }
    .bet-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        position: relative;
    }
    .bet-btn.back {
        background: #48bb78;
        color: white;
    }
    .bet-btn.back:hover {
        background: #38a169;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
    }
    .bet-btn.lay {
        background: #f56565;
        color: white;
    }
    .bet-btn.lay:hover {
        background: #e53e3e;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3);
    }
    .bet-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .header-row {
        grid-template-columns: 2fr 1fr 1fr !important;
        margin-bottom: 8px;
        padding: 8px 0;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #718096;
        font-size: 12px;
        text-transform: uppercase;
    }
    
    .session-details {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #e2e8f0;
    }
    .session-details .market-title {
        margin-bottom: 16px;
    }
    .session-detail-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 8px;
        padding: 12px 0;
        border-bottom: 1px solid #e2e8f0;
        align-items: center;
    }
    .session-detail-row:last-child {
        border-bottom: none;
    }
    .session-detail-label {
        font-weight: 500;
        color: #4a5568;
        padding: 8px 0;
    }
    
    /* Total Points */
    .total-points-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
    .points-card {
        background: #f7fafc;
        border-radius: 8px;
        padding: 24px;
        text-align: center;
        border: 1px solid #e2e8f0;
    }
    .points-label {
        font-size: 14px;
        color: #718096;
        margin-bottom: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .points-value {
        font-size: 32px;
        font-weight: 700;
        color: #2d3748;
    }
    
    /* Table Styles */
    .table-container {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        overflow: visible;
        border: none;
    }
    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    thead {
        background: #f7fafc;
    }
    th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: #2d3748;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e2e8f0;
        white-space: nowrap;
    }
    td {
        padding: 16px 20px;
        border-bottom: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 14px;
    }
    tbody tr:hover {
        background: #f7fafc;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .match-header {
            padding: 20px;
        }
        .match-info {
            flex-direction: column;
            align-items: flex-start;
        }
        .match-teams {
            font-size: 18px;
        }
        .match-meta {
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        .accordion-header {
            padding: 16px 20px;
        }
        .accordion-title {
            font-size: 16px;
        }
        .accordion-body {
            padding: 20px;
        }
        .runner-row {
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
            padding: 12px 0;
        }
        .runner-name {
            font-size: 15px;
        }
        .stake-info {
            font-size: 13px;
            margin-top: 3px;
            gap: 4px;
        }
        .stake-control-icon {
            width: 18px;
            height: 18px;
            font-size: 14px;
        }
        .odds-value {
            font-size: 16px;
            white-space: nowrap;
        }
        .odds-back {
            color: #ffffff;
            background: #48bb78;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .odds-lay {
            color: #ffffff;
            background: #f56565;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .bet-btn {
            padding: 10px 12px;
            font-size: 13px;
        }
        .session-detail-row {
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
            padding: 12px 0;
        }
        /* Mobile dropdown styles - fixed at bottom */
        .bet-dropdown {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            top: auto !important;
            width: 100vw !important;
            max-width: 100vw !important;
            min-width: 100vw !important;
            margin: 0 !important;
            border-radius: 20px 20px 0 0;
            display: flex !important;
            flex-direction: column !important;
            max-height: 70vh !important;
            z-index: 10000 !important;
            overflow: hidden;
            transform: none !important;
            animation: slideUpFromBottom 0.3s ease-out;
            /* Allow page to scroll - only capture touches on dropdown content */
            pointer-events: none;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }
        .bet-dropdown.show {
            display: flex !important;
            visibility: visible;
            opacity: 1;
            animation: slideUpFromBottom 0.3s ease-out;
            pointer-events: none;
        }
        @keyframes slideUpFromBottom {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        /* Make dropdown content interactive */
        .bet-dropdown.show .bet-dropdown-header,
        .bet-dropdown.show .bet-dropdown-body,
        .bet-dropdown.show .bet-dropdown-body *,
        .bet-dropdown.show button,
        .bet-dropdown.show input {
            pointer-events: auto;
        }
        .bet-dropdown-header {
            padding: 16px 20px;
            font-size: 16px;
            flex-shrink: 0;
        }
        .bet-dropdown-body {
            padding: 16px 12px;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            -webkit-overflow-scrolling: touch !important;
            scroll-behavior: smooth !important;
            will-change: scroll-position !important;
            flex: 1 1 auto !important;
            min-height: 0 !important;
            max-height: none !important;
            height: auto !important;
            touch-action: pan-y !important;
            overscroll-behavior: contain !important;
            overscroll-behavior-y: contain !important;
        }
        /* Allow page scrolling even when dropdown is open */
        body.bet-dropdown-open,
        html.bet-dropdown-open {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            position: relative !important;
            height: auto !important;
            -webkit-overflow-scrolling: touch !important;
            touch-action: pan-y !important;
        }
        /* Make container scrollable and add padding at bottom so content isn't hidden */
        body.bet-dropdown-open .content-area {
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            touch-action: pan-y !important;
            height: auto !important;
            max-height: none !important;
            padding-bottom: 75vh !important;
        }
        /* Ensure all page content is scrollable and touchable */
        body.bet-dropdown-open .match-header,
        body.bet-dropdown-open .accordion-container,
        body.bet-dropdown-open .accordion-content,
        body.bet-dropdown-open .runner-row,
        body.bet-dropdown-open .session-detail-row,
        body.bet-dropdown-open .betting-market {
            pointer-events: auto !important;
            touch-action: pan-y !important;
            -webkit-overflow-scrolling: touch !important;
        }
        .total-points-grid {
            grid-template-columns: 1fr;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            min-width: 700px;
        }
        th, td {
            padding: 12px 16px;
            font-size: 13px;
        }
    }
    
    @media (max-width: 480px) {
        .match-header {
            padding: 16px;
        }
        .accordion-header {
            padding: 14px 16px;
        }
        .accordion-title {
            font-size: 15px;
        }
        .accordion-body {
            padding: 16px;
        }
        .runner-row {
            grid-template-columns: 2fr 1fr 1fr;
            padding: 10px 0;
        }
        .session-detail-row {
            grid-template-columns: 2fr 1fr 1fr;
            padding: 10px 0;
        }
        .bet-dropdown {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            top: auto;
            width: 100%;
            max-width: 100%;
            min-width: 100%;
            margin: 0;
            border-radius: 12px 12px 0 0;
            z-index: 10000;
            max-height: 90vh;
            overflow: hidden;
            transform: none;
            animation: slideUpFromBottom 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }
        .bet-dropdown.show {
            display: flex !important;
            visibility: visible;
            opacity: 1;
            animation: slideUpFromBottom 0.3s ease-out;
        }
        @keyframes slideUpFromBottom {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        .bet-dropdown-header {
            padding: 16px 20px;
            font-size: 16px;
        }
        .bet-dropdown-body {
            padding: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            min-height: 0;
            max-height: calc(90vh - 60px);
            touch-action: pan-y;
            overscroll-behavior: contain;
        }
        .close-dropdown {
            width: 36px;
            height: 36px;
            font-size: 22px;
        }
        .quick-stake-buttons {
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        .quick-stake-btn {
            padding: 10px 6px;
            font-size: 12px;
        }
        .bet-dropdown-actions {
            margin-top: 20px;
        }
        .bet-submit-btn, .bet-cancel-btn {
            padding: 14px 16px;
            font-size: 14px;
        }
        .odds-value {
            font-size: 14px;
            white-space: nowrap;
        }
        .odds-back {
            color: #ffffff;
            background: #48bb78;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .odds-lay {
            color: #ffffff;
            background: #f56565;
            padding: 5px 8px;
            border-radius: 4px;
            min-width: 45px;
        }
        .bet-btn {
            padding: 8px 10px;
            font-size: 12px;
        }
        .runner-name, .session-detail-label {
            font-size: 14px;
        }
        .stake-info {
            font-size: 12px;
            margin-top: 2px;
        }
        table {
            min-width: 600px;
        }
        th, td {
            padding: 10px 12px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Match Header -->
<div class="match-header" data-match-id="{{ match.id }}">
    <div class="match-info">
        <div class="match-teams">{{ match.team_a.name }} vs {{ match.team_b.name }}</div>
        <div class="match-meta">
            <span>üìç {{ match.venue|default:"TBA" }}</span>
            <span>üìÖ {{ match.match_date|date:"M d, Y H:i" }}</span>
            <span>‚ö° {{ match.get_status_display }}</span>
        </div>
    </div>
</div>

<!-- Accordion Container -->
<div class="accordion-container">
    <!-- Match Odds Accordion -->
    <div class="accordion-item">
        <div class="accordion-header active" onclick="toggleAccordion('match-odds')">
            <span class="accordion-title">Match Odds</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="match-odds" class="accordion-content active">
            <div class="accordion-body">
                <!-- Runner Section -->
                <div class="betting-market">
                    <div class="market-title">Runner</div>
                    <div class="runner-row header-row">
                        <div>TEAM</div>
                        <div style="text-align: center;">BACK</div>
                        <div style="text-align: center;">LAY</div>
                    </div>
                    {% for odds in match_odds %}
                    <div class="runner-row" data-runner="{{ odds.runner }}" data-back-odds="{{ odds.back_odds }}" data-lay-odds="{{ odds.lay_odds }}">
                        <div class="runner-name">
                            {{ odds.runner }}
                            <span class="stake-info hidden" id="stake-{{ forloop.counter0 }}"></span>
                        </div>
                        <div class="odds-cell-wrapper">
                            <div class="odds-cell" style="text-align: center; cursor: pointer;" 
                                 data-selection="{{ odds.runner|escapejs }}" 
                                 data-type="back" 
                                 data-odds="{{ odds.back_odds }}"
                                 onclick="event.stopPropagation(); toggleBetDropdown(this);">
                                <span class="odds-back">{{ odds.back_odds }}</span>
                            </div>
                            <div class="bet-dropdown" id="dropdown-{{ forloop.counter0 }}-back">
                                <div class="bet-dropdown-header back-header">
                                    <span>BACK - {{ odds.runner }}</span>
                                    <button class="close-dropdown" onclick="closeBetDropdown(this.closest('.bet-dropdown')); return false;" type="button">√ó</button>
                                </div>
                                <div class="bet-dropdown-body">
                                    <div class="bet-input-row">
                                        <div class="bet-input-label back-label">Odds</div>
                                        <div class="odds-control">
                                            <button class="odds-btn back-btn minus" onclick="adjustOddsDropdown(this, -0.01)">-</button>
                                            <input type="number" class="odds-input-dropdown" step="0.01" min="1.01" value="{{ odds.back_odds }}" readonly>
                                            <button class="odds-btn back-btn plus" onclick="adjustOddsDropdown(this, 0.01)">+</button>
                                        </div>
                                    </div>
                                    <div class="bet-input-row">
                                        <div class="bet-input-label back-label">Stake</div>
                                        <div class="stake-control">
                                            <input type="number" class="stake-input-dropdown" min="100" step="100" placeholder="0">
                                            <span class="stake-display-dropdown">0</span>
                                        </div>
                                    </div>
                                    <div class="quick-stake-buttons">
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 1000)">+1000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 5000)">+5000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 10000)">+10000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 25000)">+25000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 50000)">+50000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 100000)">+100000</button>
                                    </div>
                                    <div class="bet-dropdown-actions">
                                        <button class="bet-cancel-btn" onclick="event.stopPropagation(); event.preventDefault(); closeBetDropdown(this.closest('.bet-dropdown'));" type="button">CANCEL</button>
                                        <button class="bet-submit-btn" onclick="event.stopPropagation(); event.preventDefault(); submitBetDropdown(this);" type="button">PLACE BET</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="odds-cell-wrapper">
                            <div class="odds-cell" style="text-align: center; cursor: pointer;" 
                                 data-selection="{{ odds.runner|escapejs }}" 
                                 data-type="lay" 
                                 data-odds="{{ odds.lay_odds }}"
                                 onclick="event.stopPropagation(); toggleBetDropdown(this);">
                                <span class="odds-lay">{{ odds.lay_odds }}</span>
                            </div>
                            <div class="bet-dropdown" id="dropdown-{{ forloop.counter0 }}-lay">
                                <div class="bet-dropdown-header lay-header">
                                    <span>LAY - {{ odds.runner }}</span>
                                    <button class="close-dropdown" onclick="closeBetDropdown(this.closest('.bet-dropdown')); return false;" type="button">√ó</button>
                                </div>
                                <div class="bet-dropdown-body">
                                    <div class="bet-input-row">
                                        <div class="bet-input-label lay-label">Odds</div>
                                        <div class="odds-control">
                                            <button class="odds-btn lay-btn minus" onclick="adjustOddsDropdown(this, -0.01)">-</button>
                                            <input type="number" class="odds-input-dropdown" step="0.01" min="1.01" value="{{ odds.lay_odds }}" readonly>
                                            <button class="odds-btn lay-btn plus" onclick="adjustOddsDropdown(this, 0.01)">+</button>
                                        </div>
                                    </div>
                                    <div class="bet-input-row">
                                        <div class="bet-input-label lay-label">Stake</div>
                                        <div class="stake-control">
                                            <input type="number" class="stake-input-dropdown" min="100" step="100" placeholder="0">
                                            <span class="stake-display-dropdown">0</span>
                                        </div>
                                    </div>
                                    <div class="quick-stake-buttons">
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 1000)">+1000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 5000)">+5000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 10000)">+10000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 25000)">+25000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 50000)">+50000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 100000)">+100000</button>
                                    </div>
                                    <div class="bet-dropdown-actions">
                                        <button class="bet-cancel-btn" onclick="event.stopPropagation(); event.preventDefault(); closeBetDropdown(this.closest('.bet-dropdown'));" type="button">CANCEL</button>
                                        <button class="bet-submit-btn" onclick="event.stopPropagation(); event.preventDefault(); submitBetDropdown(this);" type="button">PLACE BET</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Session Details Section -->
                <div class="session-details">
                    <div class="market-title">Session Details</div>
                    <div class="session-detail-row header-row">
                        <div>SESSION</div>
                        <div style="text-align: center;">BACK</div>
                        <div style="text-align: center;">LAY</div>
                    </div>
                    {% for detail in session_details %}
                    <div class="session-detail-row">
                        <div class="session-detail-label">{{ detail.label }}</div>
                        <div class="odds-cell-wrapper">
                            <div class="odds-cell" style="text-align: center; cursor: pointer;" 
                                 data-selection="{{ detail.label|escapejs }}" 
                                 data-type="not" 
                                 data-odds="{{ detail.not }}"
                                 onclick="event.stopPropagation(); toggleBetDropdown(this);">
                                <span class="odds-back">{{ detail.not }}</span>
                            </div>
                            <div class="bet-dropdown" id="dropdown-session-{{ forloop.counter0 }}-not">
                                <div class="bet-dropdown-header back-header">
                                    <span>NOT - {{ detail.label }}</span>
                                    <button class="close-dropdown" onclick="closeBetDropdown(this.closest('.bet-dropdown')); return false;" type="button">√ó</button>
                                </div>
                                <div class="bet-dropdown-body">
                                    <div class="bet-input-row">
                                        <div class="bet-input-label back-label">Odds</div>
                                        <div class="odds-control">
                                            <button class="odds-btn back-btn minus" onclick="adjustOddsDropdown(this, -0.01)">-</button>
                                            <input type="number" class="odds-input-dropdown" step="0.01" min="1.01" value="{{ detail.not }}" readonly>
                                            <button class="odds-btn back-btn plus" onclick="adjustOddsDropdown(this, 0.01)">+</button>
                                        </div>
                                    </div>
                                    <div class="bet-input-row">
                                        <div class="bet-input-label back-label">Stake</div>
                                        <div class="stake-control">
                                            <input type="number" class="stake-input-dropdown" min="100" step="100" placeholder="0">
                                            <span class="stake-display-dropdown">0</span>
                                        </div>
                                    </div>
                                    <div class="quick-stake-buttons">
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 1000)">+1000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 5000)">+5000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 10000)">+10000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 25000)">+25000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 50000)">+50000</button>
                                        <button class="quick-stake-btn back-stake" onclick="addStakeDropdown(this, 100000)">+100000</button>
                                    </div>
                                    <div class="bet-dropdown-actions">
                                        <button class="bet-cancel-btn" onclick="event.stopPropagation(); event.preventDefault(); closeBetDropdown(this.closest('.bet-dropdown'));" type="button">CANCEL</button>
                                        <button class="bet-submit-btn" onclick="event.stopPropagation(); event.preventDefault(); submitBetDropdown(this);" type="button">PLACE BET</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="odds-cell-wrapper">
                            <div class="odds-cell" style="text-align: center; cursor: pointer;" 
                                 data-selection="{{ detail.label|escapejs }}" 
                                 data-type="yes" 
                                 data-odds="{{ detail.yes }}"
                                 onclick="event.stopPropagation(); toggleBetDropdown(this);">
                                <span class="odds-lay">{{ detail.yes }}</span>
                            </div>
                            <div class="bet-dropdown" id="dropdown-session-{{ forloop.counter0 }}-yes">
                                <div class="bet-dropdown-header lay-header">
                                    <span>YES - {{ detail.label }}</span>
                                    <button class="close-dropdown" onclick="closeBetDropdown(this.closest('.bet-dropdown')); return false;" type="button">√ó</button>
                                </div>
                                <div class="bet-dropdown-body">
                                    <div class="bet-input-row">
                                        <div class="bet-input-label lay-label">Odds</div>
                                        <div class="odds-control">
                                            <button class="odds-btn lay-btn minus" onclick="adjustOddsDropdown(this, -0.01)">-</button>
                                            <input type="number" class="odds-input-dropdown" step="0.01" min="1.01" value="{{ detail.yes }}" readonly>
                                            <button class="odds-btn lay-btn plus" onclick="adjustOddsDropdown(this, 0.01)">+</button>
                                        </div>
                                    </div>
                                    <div class="bet-input-row">
                                        <div class="bet-input-label lay-label">Stake</div>
                                        <div class="stake-control">
                                            <input type="number" class="stake-input-dropdown" min="100" step="100" placeholder="0">
                                            <span class="stake-display-dropdown">0</span>
                                        </div>
                                    </div>
                                    <div class="quick-stake-buttons">
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 1000)">+1000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 5000)">+5000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 10000)">+10000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 25000)">+25000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 50000)">+50000</button>
                                        <button class="quick-stake-btn lay-stake" onclick="addStakeDropdown(this, 100000)">+100000</button>
                                    </div>
                                    <div class="bet-dropdown-actions">
                                        <button class="bet-cancel-btn" onclick="event.stopPropagation(); event.preventDefault(); closeBetDropdown(this.closest('.bet-dropdown'));" type="button">CANCEL</button>
                                        <button class="bet-submit-btn" onclick="event.stopPropagation(); event.preventDefault(); submitBetDropdown(this);" type="button">PLACE BET</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Total Points Accordion -->
    <div class="accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('total-points')">
            <span class="accordion-title">Total Points</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="total-points" class="accordion-content">
            <div class="accordion-body">
                <div class="total-points-grid">
                    <div class="points-card">
                        <div class="points-label">{{ match.team_a.name }}</div>
                        <div class="points-value">{{ total_points.team1 }}</div>
                    </div>
                    <div class="points-card">
                        <div class="points-label">{{ match.team_b.name }}</div>
                        <div class="points-value">{{ total_points.team2 }}</div>
                    </div>
                    <div class="points-card">
                        <div class="points-label">Drawn</div>
                        <div class="points-value">{{ total_points.drawn }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Match Bet Accordion -->
    <div class="accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('match-bet')">
            <span class="accordion-title">Match Bet</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="match-bet" class="accordion-content">
            <div class="accordion-body">
                <div class="table-container">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sr.</th>
                                    <th>User</th>
                                    <th>Odds</th>
                                    <th>Stake</th>
                                    <th>Bettype</th>
                                    <th>Team</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if match_bets %}
                                    {% for bet in match_bets %}
                                    <tr>
                                        <td>{{ bet.sr }}</td>
                                        <td>{{ bet.user }}</td>
                                        <td>{{ bet.odds }}</td>
                                        <td>‚Çπ{{ bet.stake|floatformat:2 }}</td>
                                        <td>{{ bet.bettype }}</td>
                                        <td>{{ bet.team }}</td>
                                        <td>{{ bet.data }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="empty-state">No match bets found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Session Accordion -->
    <div class="accordion-item">
        <div class="accordion-header" onclick="toggleAccordion('session')">
            <span class="accordion-title">Session</span>
            <span class="accordion-icon">‚ñº</span>
        </div>
        <div id="session" class="accordion-content">
            <div class="accordion-body">
                <div class="table-container">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sr.</th>
                                    <th>User</th>
                                    <th>Odds</th>
                                    <th>Stake</th>
                                    <th>Bettype</th>
                                    <th>Team</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if session_data %}
                                    {% for session in session_data %}
                                    <tr>
                                        <td>{{ session.sr }}</td>
                                        <td>{{ session.user }}</td>
                                        <td>{{ session.odds }}</td>
                                        <td>‚Çπ{{ session.stake|floatformat:2 }}</td>
                                        <td>{{ session.bettype }}</td>
                                        <td>{{ session.team }}</td>
                                        <td>{{ session.data }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="empty-state">No session data found</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleAccordion(id) {
    const content = document.getElementById(id);
    const header = content.previousElementSibling;
    
    // Toggle active class
    content.classList.toggle('active');
    header.classList.toggle('active');
}

let currentBetData = null;
let openDropdown = null;

function toggleBetDropdown(element) {
    // Get data from element attributes
    const selection = element.getAttribute('data-selection');
    const type = element.getAttribute('data-type');
    const odds = element.getAttribute('data-odds');
    
    if (!selection || !type || !odds) {
        console.error('Missing data attributes on odds cell');
        return;
    }
    
    // Find the dropdown
    const dropdown = element.nextElementSibling;
    
    if (!dropdown || !dropdown.classList.contains('bet-dropdown')) {
        return;
    }
    
    // Close any open dropdown first
    if (openDropdown && openDropdown !== dropdown) {
        closeBetDropdown(openDropdown);
    }
    
    // Toggle dropdown
    if (dropdown.classList.contains('show')) {
        closeBetDropdown(dropdown);
    } else {
        // Close any other open dropdown
        document.querySelectorAll('.bet-dropdown.show').forEach(d => {
            if (d !== dropdown) {
                closeBetDropdown(d);
            }
        });
        
        // Set data attributes on dropdown for submitBetDropdown to use
        dropdown.setAttribute('data-selection', selection);
        dropdown.setAttribute('data-type', type);
        dropdown.setAttribute('data-odds', odds);
        
        // Show dropdown
        dropdown.classList.add('show');
        dropdown.style.display = 'flex';
        dropdown.style.visibility = 'visible';
        dropdown.style.opacity = '1';
        openDropdown = dropdown;
        
        // Add class to body/html to allow scrolling while dropdown is open
        document.body.classList.add('bet-dropdown-open');
        document.documentElement.classList.add('bet-dropdown-open');
        
        // Ensure page can scroll - remove any blocking styles
        document.body.style.overflow = 'auto';
        document.body.style.position = 'relative';
        document.body.style.height = 'auto';
        document.documentElement.style.overflow = 'auto';
        document.documentElement.style.position = 'relative';
        document.documentElement.style.height = 'auto';
        
        // Make content area scrollable and add bottom padding so content isn't hidden
        const contentArea = document.querySelector('.content-area');
        if (contentArea) {
            contentArea.style.overflowY = 'auto';
            contentArea.style.webkitOverflowScrolling = 'touch';
            contentArea.style.touchAction = 'pan-y';
            // Add padding at bottom so users can scroll to see content below dropdown
            contentArea.style.paddingBottom = '75vh';
        }
        
        // Ensure page content is scrollable
        const pageContent = document.querySelector('.accordion-container');
        if (pageContent) {
            pageContent.style.pointerEvents = 'auto';
            pageContent.style.touchAction = 'pan-y';
        }
        
        // On mobile, ensure dropdown is properly configured
        if (window.innerWidth <= 768) {
            // Ensure dropdown is flex container
            dropdown.style.display = 'flex';
            dropdown.style.flexDirection = 'column';
            dropdown.style.maxHeight = '70vh';
            
            // Ensure dropdown body is scrollable with touch support
            const dropdownBody = dropdown.querySelector('.bet-dropdown-body');
            if (dropdownBody) {
                dropdownBody.style.overflowY = 'auto';
                dropdownBody.style.overflowX = 'hidden';
                dropdownBody.style.webkitOverflowScrolling = 'touch';
                dropdownBody.style.touchAction = 'pan-y';
                dropdownBody.style.overscrollBehavior = 'contain';
                dropdownBody.style.overscrollBehaviorY = 'contain';
                dropdownBody.style.scrollBehavior = 'smooth';
                dropdownBody.style.flex = '1 1 auto';
                dropdownBody.style.minHeight = '0';
                dropdownBody.style.maxHeight = 'none';
                dropdownBody.style.height = 'auto';
                
                // Ensure header doesn't shrink
                const dropdownHeader = dropdown.querySelector('.bet-dropdown-header');
                if (dropdownHeader) {
                    dropdownHeader.style.flexShrink = '0';
                }
            }
        }
        
        // Initialize dropdown data
        const oddsInput = dropdown.querySelector('.odds-input-dropdown');
        const stakeInput = dropdown.querySelector('.stake-input-dropdown');
        const stakeDisplay = dropdown.querySelector('.stake-display-dropdown');
        
        if (oddsInput) oddsInput.value = odds;
        if (stakeInput) {
            stakeInput.value = '';
            // Remove existing listeners and add new one
            const newStakeInput = stakeInput.cloneNode(true);
            stakeInput.parentNode.replaceChild(newStakeInput, stakeInput);
            newStakeInput.addEventListener('input', function() {
                updateStakeDisplayDropdown(this, dropdown.querySelector('.stake-display-dropdown'));
            });
        }
        if (stakeDisplay) stakeDisplay.textContent = '0';
        
        // Store selection and type in dropdown for submit function
        dropdown.setAttribute('data-selection', selection);
        dropdown.setAttribute('data-type', type);
        
        // Focus on stake input
        setTimeout(() => {
            const focusInput = dropdown.querySelector('.stake-input-dropdown');
            if (focusInput) focusInput.focus();
        }, 100);
    }
}

function closeBetDropdown(dropdownElement) {
    let dropdown = null;
    
    if (typeof dropdownElement === 'object' && dropdownElement.closest) {
        // If it's a button, find the dropdown
        dropdown = dropdownElement.closest('.bet-dropdown');
    } else if (dropdownElement && dropdownElement.classList) {
        // If it's the dropdown itself
        dropdown = dropdownElement;
    }
    
    if (dropdown) {
        // Remove show class
        dropdown.classList.remove('show');
        
        // Force hide
        dropdown.style.display = 'none';
        dropdown.style.visibility = 'hidden';
        dropdown.style.opacity = '0';
        
        if (openDropdown === dropdown) {
            openDropdown = null;
        }
        
        // Remove class from body/html when dropdown closes
        if (!document.querySelector('.bet-dropdown.show')) {
            document.body.classList.remove('bet-dropdown-open');
            document.documentElement.classList.remove('bet-dropdown-open');
            
            // Remove bottom padding from content area
            const contentArea = document.querySelector('.content-area');
            if (contentArea) {
                contentArea.style.paddingBottom = '';
            }
        }
    }
}

// Close dropdown when clicking outside (desktop only)
document.addEventListener('click', function(e) {
    if (openDropdown && window.innerWidth > 768) {
        if (!openDropdown.contains(e.target)) {
            const oddsCell = e.target.closest('.odds-cell');
            if (!oddsCell || oddsCell.nextElementSibling !== openDropdown) {
                closeBetDropdown(openDropdown);
            }
        }
    }
});

function openBetModal(selection, type, odds) {
    currentBetData = {
        selection: selection,
        type: type,
        odds: parseFloat(odds)
    };
    
    // Update modal content
    const modalTitle = document.getElementById('betModalTitle');
    const modalHeader = document.querySelector('.bet-modal-header');
    const oddsBtns = document.querySelectorAll('.odds-btn');
    const stakeBtns = document.querySelectorAll('.quick-stake-btn');
    const inputLabels = document.querySelectorAll('.bet-input-label');
    
    modalTitle.textContent = type.toUpperCase();
    modalHeader.className = 'bet-modal-header ' + type.toLowerCase() + '-header';
    
    // Update label colors
    inputLabels.forEach(label => {
        label.className = 'bet-input-label ' + type.toLowerCase() + '-label';
    });
    
    // Update odds button colors
    oddsBtns.forEach(btn => {
        btn.className = 'odds-btn ' + type.toLowerCase() + '-btn';
        if (btn.textContent === '-') {
            btn.classList.add('minus');
        } else {
            btn.classList.add('plus');
        }
    });
    
    // Update quick stake button colors
    stakeBtns.forEach(btn => {
        btn.className = 'quick-stake-btn ' + type.toLowerCase() + '-stake';
    });
    
    document.getElementById('betSelection').textContent = selection;
    document.getElementById('betOdds').value = odds;
    document.getElementById('betAmount').value = '';
    document.querySelector('.stake-display').textContent = '0';
    
    // Show modal at bottom
    const modal = document.getElementById('betModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Initialize stake input listener
    initStakeInput();
    
    // Update stake info display below team names (will show when stake is entered)
    // Note: updateStakeInfo will be called when stake amount changes
    
    // Focus on stake input
    setTimeout(() => {
        document.getElementById('betAmount').focus();
    }, 100);
}

function adjustOddsDropdown(button, change) {
    const dropdown = button.closest('.bet-dropdown');
    if (!dropdown) return;
    
    const oddsInput = dropdown.querySelector('.odds-input-dropdown');
    if (!oddsInput) return;
    
    let currentOdds = parseFloat(oddsInput.value) || 1.01;
    let newOdds = currentOdds + change;
    
    // Ensure minimum odds of 1.01
    if (newOdds < 1.01) {
        newOdds = 1.01;
    }
    
    // Round to 2 decimal places
    newOdds = Math.round(newOdds * 100) / 100;
    oddsInput.value = newOdds.toFixed(2);
    
    // Update stake display if stake is entered
    const stakeInput = dropdown.querySelector('.stake-input-dropdown');
    const stakeAmount = parseFloat(stakeInput ? stakeInput.value : 0) || 0;
    if (stakeAmount > 0) {
        updateStakeDisplayDropdown(stakeInput, dropdown.querySelector('.stake-display-dropdown'));
    }
}

function addStakeDropdown(button, amount) {
    const dropdown = button.closest('.bet-dropdown');
    if (!dropdown) return;
    
    const stakeInput = dropdown.querySelector('.stake-input-dropdown');
    if (!stakeInput) return;
    
    const currentStake = parseFloat(stakeInput.value) || 0;
    const newStake = currentStake + amount;
    stakeInput.value = newStake;
    updateStakeDisplayDropdown(stakeInput, dropdown.querySelector('.stake-display-dropdown'));
}

function updateStakeDisplayDropdown(stakeInput, stakeDisplay) {
    if (!stakeInput || !stakeDisplay) return;
    
    const amount = parseFloat(stakeInput.value) || 0;
    stakeDisplay.textContent = amount.toLocaleString('en-IN');
}

function updateStakeDisplay(amount) {
    document.querySelector('.stake-display').textContent = amount || '0';
}

// Update stake display on input change (will be initialized when modal opens)
function initStakeInput() {
    const stakeInput = document.getElementById('betAmount');
    if (stakeInput) {
        // Remove existing listener if any
        stakeInput.removeEventListener('input', handleStakeInput);
        stakeInput.addEventListener('input', handleStakeInput);
    }
}

function handleStakeInput() {
    const stake = parseFloat(this.value) || 0;
    updateStakeDisplay(stake);
    
    // Update stake info below team names when stake changes
    if (currentBetData) {
        updateStakeInfo(currentBetData.selection, currentBetData.type, currentBetData.odds, stake);
    }
}

// Store stake data for each runner row
let stakeDataMap = {};

// Get match ID from the page (we'll need to add a data attribute or use match.id if available)
function getMatchId() {
    // Try to get from a data attribute or URL
    const matchHeader = document.querySelector('.match-header');
    if (matchHeader && matchHeader.dataset.matchId) {
        return matchHeader.dataset.matchId;
    }
    // Fallback: try to extract from URL
    const pathParts = window.location.pathname.split('/');
    const matchIdIndex = pathParts.indexOf('match') + 1;
    return matchIdIndex > 0 ? pathParts[matchIdIndex] : null;
}

// Load persisted stake data from localStorage
function loadStakeData() {
    const matchId = getMatchId();
    if (!matchId) return;
    
    const key = `match_${matchId}_stakes`;
    const savedData = localStorage.getItem(key);
    if (savedData) {
        try {
            stakeDataMap = JSON.parse(savedData);
            // Restore display for all saved stakes
            Object.keys(stakeDataMap).forEach(index => {
                const data = stakeDataMap[index];
                updateStakeDisplayFromData(parseInt(index), data);
            });
        } catch (e) {
            console.error('Error loading stake data:', e);
        }
    }
}

// Save stake data to localStorage
function saveStakeData() {
    const matchId = getMatchId();
    if (!matchId) return;
    
    const key = `match_${matchId}_stakes`;
    localStorage.setItem(key, JSON.stringify(stakeDataMap));
}

// Update stake display from saved data
function updateStakeDisplayFromData(rowIndex, data) {
    const runnerRows = document.querySelectorAll('.runner-row[data-runner]');
    if (rowIndex >= runnerRows.length) return;
    
    const row = runnerRows[rowIndex];
    const stakeElement = row.querySelector('.stake-info');
    if (!stakeElement) return;
    
    // Create the display text
    const displayText = data.value > 0 ? `+${data.value}` : `${data.value}`;
    stakeElement.textContent = displayText;
    stakeElement.className = `stake-info ${data.type === 'lay' || data.type === 'yes' ? 'lay-stake' : 'back-stake'}`;
    stakeElement.classList.remove('hidden');
}

function updateStakeInfo(selection, type, odds, stakeAmount = null) {
    // Get stake amount from input if not provided
    if (stakeAmount === null) {
        const stakeInput = document.getElementById('betAmount');
        stakeAmount = parseFloat(stakeInput ? stakeInput.value : 0) || 0;
    }
    
    if (stakeAmount <= 0) {
        return;
    }
    
    // Find all runner rows
    const runnerRows = document.querySelectorAll('.runner-row[data-runner]');
    let selectedRow = null;
    let otherRow = null;
    let selectedIndex = -1;
    let otherIndex = -1;
    
    runnerRows.forEach((row, index) => {
        if (row.getAttribute('data-runner') === selection) {
            selectedRow = row;
            selectedIndex = index;
        } else {
            otherRow = row;
            otherIndex = index;
        }
    });
    
    if (!selectedRow || !otherRow) return;
    
    // Get odds for both teams
    const selectedLayOdds = parseFloat(selectedRow.getAttribute('data-lay-odds'));
    const selectedBackOdds = parseFloat(selectedRow.getAttribute('data-back-odds'));
    const otherLayOdds = parseFloat(otherRow.getAttribute('data-lay-odds'));
    const otherBackOdds = parseFloat(otherRow.getAttribute('data-back-odds'));
    
    // Calculate stake display values based on type
    if (type === 'lay' || type === 'yes') {
        // For lay: show stake amount in red for selected team (what you receive/lose)
        // For other team: show stake amount in green (profit if selected team loses)
        const selectedStakeElement = selectedRow.querySelector('.stake-info');
        const otherStakeElement = otherRow.querySelector('.stake-info');
        
        // Based on user example: lay at 1.95 with stake 100 shows "90" in red
        // This appears to be: stake - (lay_odds - back_odds) * stake
        // Or simplified: stake * (1 - (lay_odds - back_odds))
        // For 1.90/1.95 with stake 100: 100 * (1 - 0.05) = 95... still not 90
        
        // Let me try: stake - (lay_odds - 1) * stake / 10 = 100 - 95/10 = 90.5 ‚âà 90
        // Or: stake * back_odds / lay_odds * 100 = 100 * 1.90 / 1.95 * 100 = 9743... no
        
        // Actually, maybe it's: stake * (back_odds - 1) = 100 * 0.90 = 90! That matches!
        // So for lay, show: stake * (back_odds - 1) in red
        let selectedValue = Math.round(stakeAmount * (selectedBackOdds - 1));
        let otherValue = Math.round(stakeAmount);
        
        // If there are existing stakes, add/subtract accordingly
        if (existingSelectedData) {
            selectedValue = existingSelectedData.value + selectedValue;
        }
        if (existingOtherData) {
            otherValue = existingOtherData.value + otherValue;
        }
        
        if (selectedStakeElement) {
            // Format: +value or -value as text
            const displayText = selectedValue > 0 ? `+${selectedValue}` : `${selectedValue}`;
            selectedStakeElement.textContent = displayText;
            selectedStakeElement.className = 'stake-info lay-stake';
            selectedStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingAmount = existingSelectedData ? existingSelectedData.stakeAmount : 0;
            stakeDataMap[selectedIndex] = {
                selection: selection,
                type: type,
                odds: odds,
                stakeAmount: existingAmount + stakeAmount,
                value: selectedValue
            };
        }
        
        if (otherStakeElement) {
            // Format: +value or -value as text
            const displayText = otherValue > 0 ? `+${otherValue}` : `${otherValue}`;
            otherStakeElement.textContent = displayText;
            otherStakeElement.className = 'stake-info back-stake';
            otherStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingOtherAmount = existingOtherData ? existingOtherData.stakeAmount : 0;
            stakeDataMap[otherIndex] = {
                selection: otherRow.getAttribute('data-runner'),
                type: 'back',
                odds: otherBackOdds,
                stakeAmount: existingOtherAmount + stakeAmount,
                value: otherValue
            };
        }
        
        // Save to localStorage
        saveStakeData();
    } else if (type === 'back' || type === 'not') {
        // For back: show profit (what you win) in green for selected team
        // For other team: show stake amount in red (liability)
        const selectedStakeElement = selectedRow.querySelector('.stake-info');
        const otherStakeElement = otherRow.querySelector('.stake-info');
        
        // Profit for back: (odds - 1) * stake
        let profit = Math.round((selectedBackOdds - 1) * stakeAmount);
        let liability = Math.round(stakeAmount);
        
        // If there are existing stakes, add/subtract accordingly
        if (existingSelectedData) {
            profit = existingSelectedData.value + profit;
        }
        if (existingOtherData) {
            liability = existingOtherData.value + liability;
        }
        
        if (selectedStakeElement) {
            // Format: +value or -value as text
            const displayText = profit > 0 ? `+${profit}` : `${profit}`;
            selectedStakeElement.textContent = displayText;
            selectedStakeElement.className = 'stake-info back-stake';
            selectedStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingAmount = existingSelectedData ? existingSelectedData.stakeAmount : 0;
            stakeDataMap[selectedIndex] = {
                selection: selection,
                type: type,
                odds: odds,
                stakeAmount: existingAmount + stakeAmount,
                value: profit
            };
        }
        
        if (otherStakeElement) {
            // Format: +value or -value as text
            const displayText = liability > 0 ? `+${liability}` : `${liability}`;
            otherStakeElement.textContent = displayText;
            otherStakeElement.className = 'stake-info lay-stake';
            otherStakeElement.classList.remove('hidden');
            // Store/update stake data for this row (accumulate if exists)
            const existingOtherAmount = existingOtherData ? existingOtherData.stakeAmount : 0;
            stakeDataMap[otherIndex] = {
                selection: otherRow.getAttribute('data-runner'),
                type: 'lay',
                odds: otherLayOdds,
                stakeAmount: existingOtherAmount + stakeAmount,
                value: liability
            };
        }
        
        // Save to localStorage
        saveStakeData();
    }
}

function adjustStakeFromRow(rowIndex, change) {
    event.stopPropagation();
    const stakeData = stakeDataMap[rowIndex];
    if (!stakeData) return;
    
    // Calculate new stake amount based on the stored data
    const newStakeAmount = Math.max(100, stakeData.stakeAmount + change);
    
    // Update the stake info with new amount
    updateStakeInfo(stakeData.selection, stakeData.type, stakeData.odds, newStakeAmount);
    
    // If modal is open, update the stake input
    const modal = document.getElementById('betModal');
    if (modal && modal.classList.contains('show')) {
        const stakeInput = document.getElementById('betAmount');
        if (stakeInput) {
            stakeInput.value = newStakeAmount;
            updateStakeDisplay(newStakeAmount);
        }
    }
}

function closeBetModal() {
    const modal = document.getElementById('betModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    currentBetData = null;
    
    // Keep stake info visible after modal closes - don't hide it
}

function submitBetDropdown(button) {
    const dropdown = button.closest('.bet-dropdown');
    if (!dropdown) return;
    
    // Get selection and type from dropdown data attributes
    const selection = dropdown.getAttribute('data-selection');
    const type = dropdown.getAttribute('data-type');
    
    if (!selection || !type) {
        console.error('Missing data attributes on dropdown');
        return;
    }
    
    const stakeInput = dropdown.querySelector('.stake-input-dropdown');
    const oddsInput = dropdown.querySelector('.odds-input-dropdown');
    
    if (!stakeInput || !oddsInput) return;
    
    const amount = parseFloat(stakeInput.value);
    const odds = parseFloat(oddsInput.value);
    
    if (!amount || amount < 100) {
        // Validation failed - silently return (user can see the error from input field)
        return;
    }
    
    // Get match ID from the page
    const matchId = {{ match.id }};
    
    // Place bet via API
    fetch(`/dl/match/${matchId}/place-bet/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            selection: selection,
            bet_type: type,
            odds: odds,
            stake: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update balances
            if (data.balances) {
                updateBalances(data.balances);
            }
            
            // Close the dropdown
            closeBetDropdown(dropdown);
            
            // Clear input
            stakeInput.value = '';
            const stakeDisplay = dropdown.querySelector('.stake-display-dropdown');
            if (stakeDisplay) stakeDisplay.textContent = '0';
            
            // Reload the page to refresh the bets table
            window.location.reload();
        } else {
            // Error occurred - log to console but don't show alert
            console.error('Error placing bet:', data.error || 'Failed to place bet');
        }
    })
    .catch(error => {
        console.error('Error placing bet:', error);
        // Don't show alert on error
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateBalances(balances) {
    // Update balances for each selection
    Object.keys(balances).forEach(selection => {
        const balance = balances[selection];
        updateBalanceDisplay(selection, balance);
    });
}

function updateBalanceDisplay(selection, balance) {
    // Find the runner row that matches the selection
    const runnerRows = document.querySelectorAll('.runner-row[data-runner]');
    let targetRow = null;
    
    runnerRows.forEach((row) => {
        if (row.getAttribute('data-runner') === selection) {
            targetRow = row;
        }
    });
    
    if (!targetRow) return;
    
    // Find or create balance display element
    let balanceDisplay = targetRow.querySelector('.balance-display');
    
    if (!balanceDisplay) {
        const runnerName = targetRow.querySelector('.runner-name');
        if (runnerName) {
            balanceDisplay = document.createElement('div');
            balanceDisplay.className = 'balance-display';
            runnerName.appendChild(balanceDisplay);
        }
    }
    
    if (balanceDisplay) {
        const formattedBalance = balance >= 0 ? `+${balance.toFixed(0)}` : `${balance.toFixed(0)}`;
        balanceDisplay.textContent = formattedBalance;
        balanceDisplay.className = 'balance-display ' + (balance >= 0 ? 'balance-positive' : 'balance-negative');
        balanceDisplay.classList.remove('hidden');
    }
}

function displayBetInfo(selection, type, odds, amount) {
    // Find the runner row that matches the selection
    const runnerRows = document.querySelectorAll('.runner-row[data-runner]');
    let targetRow = null;
    let rowIndex = -1;
    
    runnerRows.forEach((row, index) => {
        if (row.getAttribute('data-runner') === selection) {
            targetRow = row;
            rowIndex = index;
        }
    });
    
    if (!targetRow) {
        // Try session details
        const sessionRows = document.querySelectorAll('.session-detail-row');
        sessionRows.forEach((row, index) => {
            const label = row.querySelector('.session-detail-label');
            if (label && label.textContent.trim() === selection) {
                targetRow = row;
                rowIndex = index;
            }
        });
    }
    
    if (!targetRow) return;
    
    // Find the stake info element (it should already exist in the HTML)
    let stakeInfo = targetRow.querySelector('.stake-info');
    
    if (!stakeInfo) {
        // If it doesn't exist, create it
        const runnerName = targetRow.querySelector('.runner-name, .session-detail-label');
        if (runnerName) {
            stakeInfo = document.createElement('span');
            stakeInfo.className = 'stake-info';
            runnerName.appendChild(stakeInfo);
        }
    }
    
    if (stakeInfo) {
        // Format the display text: "BACK @ 1.85 - ‚Çπ1,000" or "LAY @ 1.90 - ‚Çπ1,000"
        const displayText = `${type.toUpperCase()} @ ${odds} - ‚Çπ${amount.toLocaleString('en-IN')}`;
        stakeInfo.textContent = displayText;
        
        // Set color based on type (green for back/not, red for lay/yes)
        if (type === 'back' || type === 'not') {
            stakeInfo.className = 'stake-info back-stake';
            stakeInfo.style.color = '#48bb78';
        } else {
            stakeInfo.className = 'stake-info lay-stake';
            stakeInfo.style.color = '#f56565';
        }
        
        // Make sure it's visible
        stakeInfo.classList.remove('hidden');
        stakeInfo.style.display = 'block';
    }
}

// Close dropdown on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && openDropdown) {
        closeBetDropdown(openDropdown);
    }
});

// Add swipe down to close on mobile
let touchStartY = 0;
let touchStartTime = 0;

document.addEventListener('touchstart', function(e) {
    if (openDropdown && window.innerWidth <= 768) {
        const header = openDropdown.querySelector('.bet-dropdown-header');
        if (header && header.contains(e.target)) {
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }
    }
}, { passive: true });

document.addEventListener('touchmove', function(e) {
    if (openDropdown && window.innerWidth <= 768) {
        const header = openDropdown.querySelector('.bet-dropdown-header');
        if (header && header.contains(e.target)) {
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - touchStartY;
            
            // If swiping down more than 50px, allow it
            if (deltaY > 50) {
                e.preventDefault();
                openDropdown.style.transform = `translateY(${deltaY}px)`;
            }
        }
    }
}, { passive: false });

document.addEventListener('touchend', function(e) {
    if (openDropdown && window.innerWidth <= 768) {
        const header = openDropdown.querySelector('.bet-dropdown-header');
        if (header && header.contains(e.target)) {
            const touchY = e.changedTouches[0].clientY;
            const deltaY = touchY - touchStartY;
            const deltaTime = Date.now() - touchStartTime;
            
            // Reset transform
            openDropdown.style.transform = '';
            
            // If swiped down more than 100px or fast swipe down, close
            if (deltaY > 100 || (deltaY > 50 && deltaTime < 300)) {
                closeBetDropdown(openDropdown);
            }
        }
    }
}, { passive: true });

// Load stake data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadStakeData();
    
    // Ensure all dropdowns are hidden on page load
    document.querySelectorAll('.bet-dropdown').forEach(dropdown => {
        dropdown.classList.remove('show');
        dropdown.style.display = 'none';
        dropdown.style.visibility = 'hidden';
        dropdown.style.opacity = '0';
    });
});
</script>

<!-- Bet Modal -->
<div id="betModal" class="bet-modal">
    <div class="bet-modal-overlay" onclick="closeBetModal()"></div>
    <div class="bet-modal-content">
        <div class="bet-modal-header lay-header">
            <h3 id="betModalTitle" class="bet-type-header">LAY</h3>
        </div>
        <div class="bet-modal-body">
            <div class="bet-selection-info">
                <div class="bet-team-name" id="betSelection"></div>
            </div>
            
            <div class="bet-input-section">
                <div class="bet-input-row">
                    <div class="bet-input-label">Odds</div>
                    <div class="odds-control">
                        <button class="odds-btn minus" onclick="adjustOdds(-0.01)">-</button>
                        <input type="number" id="betOdds" step="0.01" min="1.01" value="1.01" class="odds-input" readonly>
                        <button class="odds-btn plus" onclick="adjustOdds(0.01)">+</button>
                    </div>
                </div>
                
                <div class="bet-input-row">
                    <div class="bet-input-label">Stake</div>
                    <div class="stake-control">
                        <input type="number" id="betAmount" min="100" step="100" placeholder="0" class="stake-input" autofocus>
                        <span class="stake-display">0</span>
                    </div>
                </div>
            </div>
            
            <div class="quick-stake-buttons">
                <button class="quick-stake-btn" onclick="addStake(1000)">+1000</button>
                <button class="quick-stake-btn" onclick="addStake(5000)">+5000</button>
                <button class="quick-stake-btn" onclick="addStake(10000)">+10000</button>
                <button class="quick-stake-btn" onclick="addStake(25000)">+25000</button>
                <button class="quick-stake-btn" onclick="addStake(50000)">+50000</button>
                <button class="quick-stake-btn" onclick="addStake(100000)">+100000</button>
            </div>
            
            <div class="bet-modal-actions">
                <button class="bet-cancel-btn" onclick="closeBetModal()">CANCEL</button>
                <button class="bet-submit-btn" onclick="submitBet()">PLACE BET</button>
            </div>
        </div>
    </div>
</div>

<style>
    .bet-modal {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: none !important;
        visibility: hidden;
    }
    .bet-modal.show {
        display: flex !important;
        align-items: flex-end;
        justify-content: center;
    }
    .bet-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        pointer-events: auto;
    }
    .bet-modal-content {
        position: relative;
        background: white;
        border-radius: 12px 12px 0 0;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        z-index: 10001;
        animation: slideUpFromBottom 0.3s ease-out;
        max-height: 90vh;
        overflow-y: auto;
    }
    @keyframes slideUpFromBottom {
        from {
            transform: translateY(100%);
        }
        to {
            transform: translateY(0);
        }
    }
    .bet-modal-header {
        padding: 16px 20px;
        color: white;
    }
    .bet-modal-header.back-header {
        background: #4299e1;
    }
    .bet-modal-header.lay-header {
        background: #ec4899;
    }
    .bet-type-header {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .bet-input-label.back-label {
        color: #4299e1;
    }
    .bet-input-label.lay-label {
        color: #ec4899;
    }
    .odds-btn.back-btn {
        border-color: #4299e1;
        color: #4299e1;
    }
    .odds-btn.back-btn:hover {
        background: #4299e1;
        color: white;
    }
    .odds-btn.lay-btn {
        border-color: #ec4899;
        color: #ec4899;
    }
    .odds-btn.lay-btn:hover {
        background: #ec4899;
        color: white;
    }
    .quick-stake-btn.back-stake {
        background: #4299e1;
    }
    .quick-stake-btn.back-stake:hover {
        background: #3182ce;
    }
    .quick-stake-btn.lay-stake {
        background: #ec4899;
    }
    .quick-stake-btn.lay-stake:hover {
        background: #db2777;
    }
    .bet-modal-body {
        padding: 20px;
    }
    .bet-selection-info {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e2e8f0;
    }
    .bet-team-name {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
    }
    .bet-input-section {
        margin-bottom: 20px;
    }
    .bet-input-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .bet-input-label {
        font-weight: 600;
        color: #ec4899;
        font-size: 16px;
        text-transform: uppercase;
    }
    .odds-input-dropdown {
        width: 80px;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        background: #f7fafc;
        color: #2d3748;
    }
    .stake-input-dropdown {
        width: 120px;
        padding: 10px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        text-align: center;
        transition: all 0.2s;
    }
    .stake-input-dropdown:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    .stake-display-dropdown {
        font-size: 16px;
        color: #718096;
        min-width: 40px;
    }
    .odds-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .odds-btn {
        width: 36px;
        height: 36px;
        border: 2px solid #ec4899;
        background: white;
        color: #ec4899;
        border-radius: 6px;
        font-size: 20px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .odds-btn:hover {
        background: #ec4899;
        color: white;
    }
    .odds-input {
        width: 80px;
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        text-align: center;
        background: #f7fafc;
        color: #2d3748;
    }
    .stake-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .stake-input {
        width: 120px;
        padding: 10px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 16px;
        text-align: center;
        transition: all 0.2s;
    }
    .stake-input:focus {
        outline: none;
        border-color: #ec4899;
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }
    .stake-display {
        font-size: 16px;
        color: #718096;
        min-width: 40px;
    }
    .quick-stake-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 24px;
    }
    .quick-stake-btn {
        padding: 12px 8px;
        border: none;
        border-radius: 6px;
        background: #ec4899;
        color: white;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .quick-stake-btn:hover {
        background: #db2777;
        transform: translateY(-1px);
    }
    .bet-modal-actions {
        display: flex;
        gap: 12px;
    }
    .bet-submit-btn, .bet-cancel-btn {
        flex: 1;
        padding: 16px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
    }
    .bet-submit-btn {
        background: #48bb78;
        color: white;
    }
    .bet-submit-btn:hover {
        background: #38a169;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
    }
    .bet-cancel-btn {
        background: #f56565;
        color: white;
    }
    .bet-cancel-btn:hover {
        background: #e53e3e;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 101, 101, 0.3);
    }
    
    @media (max-width: 480px) {
        .bet-modal-content {
            max-height: 95vh;
        }
        .bet-modal-header {
            padding: 14px 16px;
        }
        .bet-modal-body {
            padding: 16px;
        }
        .quick-stake-buttons {
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        .quick-stake-btn {
            padding: 10px 6px;
            font-size: 12px;
        }
        .bet-submit-btn, .bet-cancel-btn {
            padding: 14px 16px;
            font-size: 14px;
        }
    }
</style>
{% endblock %}
