{% extends 'core/base.html' %}

{% block title %}Session #{{ session.id }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Betting Session #{{ session.id }}</h1>
    <p>{{ session.match.team_a.name }} vs {{ session.match.team_b.name }}</p>
</div>

<!-- Match Info Card -->
<div class="card">
    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        {% if session.match.team_a.logo %}
            <img src="{{ session.match.team_a.logo.url }}" alt="{{ session.match.team_a.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% elif session.match.team_a.logo_url %}
            <img src="{{ session.match.team_a.logo_url }}" alt="{{ session.match.team_a.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% else %}
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-weight: 600;">
                {{ session.match.team_a.name|first|upper }}
            </div>
        {% endif %}
        <div style="flex: 1;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">{{ session.match.team_a.name }} vs {{ session.match.team_b.name }}</h3>
            <p style="margin: 4px 0 0 0; color: #718096; font-size: 14px;">{{ session.match.match_title }}</p>
        </div>
        {% if session.match.team_b.logo %}
            <img src="{{ session.match.team_b.logo.url }}" alt="{{ session.match.team_b.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% elif session.match.team_b.logo_url %}
            <img src="{{ session.match.team_b.logo_url }}" alt="{{ session.match.team_b.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% else %}
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-weight: 600;">
                {{ session.match.team_b.name|first|upper }}
            </div>
        {% endif %}
    </div>
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; display: flex; gap: 16px; flex-wrap: wrap;">
        <div>
            <span style="color: #718096; font-size: 13px;">Status:</span>
            <span class="status-badge {% if session.status == 'completed' %}status-completed{% elif session.status == 'betting' %}status-warning{% else %}status-info{% endif %}" style="margin-left: 8px;">
                {{ session.get_status_display }}
            </span>
        </div>
        <div>
            <span style="color: #718096; font-size: 13px;">Players per side:</span>
            <strong style="margin-left: 8px;">{{ session.players_per_side }}</strong>
        </div>
    </div>
</div>

<!-- Progress Steps -->
<div class="card">
    <div class="progress-steps">
        <div class="progress-step {% if session.status == 'pending' %}active{% elif session.status != 'pending' %}completed{% endif %}">
            <div class="progress-step-circle">1</div>
            <div class="progress-step-label">Join</div>
        </div>
        <div class="progress-step {% if session.status == 'picking' %}active{% elif session.status == 'betting' or session.status == 'completed' %}completed{% endif %}">
            <div class="progress-step-circle">2</div>
            <div class="progress-step-label">Pick Players</div>
        </div>
        <div class="progress-step {% if session.status == 'betting' %}active{% elif session.status == 'completed' %}completed{% endif %}">
            <div class="progress-step-circle">3</div>
            <div class="progress-step-label">Place Bets</div>
        </div>
        <div class="progress-step {% if session.status == 'completed' %}active{% endif %}">
            <div class="progress-step-circle">4</div>
            <div class="progress-step-label">Results</div>
        </div>
    </div>
</div>

<!-- Step 1: Waiting for Player / Toss -->
{% if session.status == 'pending' %}
    {% if session.better_b == session.better_a %}
        <div class="card" style="background: #ebf8ff; border-color: #4299e1;">
            <h3 style="margin: 0 0 12px 0;">Waiting for Opponent</h3>
            <p style="margin: 0 0 16px 0; color: #2c5282;">Share this session with a friend to start playing. Session ID: <strong>#{{ session.id }}</strong></p>
        </div>
    {% elif can_perform_toss and not toss_completed %}
        <div class="card" style="background: #fffaf0; border-color: #ed8936;">
            <h3 style="margin: 0 0 12px 0;">Toss Required</h3>
            <p style="margin: 0 0 16px 0; color: #7c2d12;">Both players have joined. Perform the toss to determine who picks first.</p>
            <form method="post" action="{% url 'core:perform_toss' session.id %}" style="margin-top: 16px;">
                {% csrf_token %}
                <button type="submit" class="btn">Perform Toss</button>
            </form>
        </div>
    {% endif %}
{% endif %}

{% if toss_completed %}
    <div class="card" style="background: #f0fff4; border-color: #48bb78;">
        <p style="margin: 0; color: #22543d;">
            <strong>Toss Winner:</strong> <strong>{{ toss_winner.username }}</strong> will pick first.
        </p>
    </div>
{% endif %}

<!-- Step 2: Picking Players -->
{% if session.status == 'picking' %}
    <!-- Toast notification container -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 350px;"></div>
    
    <div class="card" id="turn-indicator" data-is-my-turn="{% if is_my_turn %}true{% else %}false{% endif %}" data-current-turn-user="{{ session.current_turn.username|default:'' }}">
        {% if is_my_turn %}
            <div style="background: #ebf8ff; padding: 16px; border-radius: 6px; border-left: 4px solid #4299e1;">
                <h3 style="margin: 0 0 8px 0; color: #2c5282;">Your Turn</h3>
                <p style="margin: 0; color: #2c5282;">Select a player from either team below. You need to pick {{ session.players_per_side }} players from each team.</p>
            </div>
        {% else %}
            <div style="background: #fffaf0; padding: 16px; border-radius: 6px; border-left: 4px solid #ed8936;">
                <h3 style="margin: 0 0 8px 0; color: #7c2d12;">Waiting</h3>
                <p style="margin: 0; color: #7c2d12;">Waiting for <strong>{{ session.current_turn.username }}</strong> to pick a player. This page will update automatically.</p>
                <p style="margin: 8px 0 0 0; color: #7c2d12; font-size: 12px;">ðŸ”” You'll be notified when it's your turn</p>
            </div>
        {% endif %}
    </div>

    <!-- Player Selection Progress -->
    <div class="card" id="progress-card">
        <div class="card-header">
            <h3>Your Progress</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div style="text-align: center; padding: 20px; background: #f7fafc; border-radius: 6px;">
                <div id="team-a-progress" style="font-size: 32px; font-weight: 600; color: #4299e1; transition: all 0.3s ease;">
                    {% if session.better_a == user %}{{ better_a_team_a_count }}{% else %}{{ better_b_team_a_count }}{% endif %}/{{ session.players_per_side }}
                </div>
                <div style="color: #718096; margin-top: 8px; font-size: 14px;">{{ session.match.team_a.name }}</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #f7fafc; border-radius: 6px;">
                <div id="team-b-progress" style="font-size: 32px; font-weight: 600; color: #4299e1; transition: all 0.3s ease;">
                    {% if session.better_a == user %}{{ better_a_team_b_count }}{% else %}{{ better_b_team_b_count }}{% endif %}/{{ session.players_per_side }}
                </div>
                <div style="color: #718096; margin-top: 8px; font-size: 14px;">{{ session.match.team_b.name }}</div>
            </div>
        </div>
        <div style="text-align: center; padding: 12px; background: #ebf8ff; border-radius: 6px; color: #2c5282;">
            <strong>Total Picked:</strong> 
            <span id="total-picked">
                {% if session.better_a == user %}
                    {{ better_a_picks|length }}
                {% else %}
                    {{ better_b_picks|length }}
                {% endif %}
            </span>
            /{{ session.players_per_side|add:session.players_per_side }}
        </div>
    </div>

    <!-- Available Players -->
    {% if is_my_turn %}
        <div class="card">
            <div class="card-header">
                <h3>{{ session.match.team_a.name }} Players</h3>
            </div>
            <div class="player-list" id="team-a-players-list">
                {% for player in team_a_available %}
                    <div class="player-card" data-player-id="{{ player.id }}" onclick="pickPlayer({{ player.id }})">
                        {% if player.picture %}
                            <img src="{{ player.picture.url }}" alt="{{ player.name }}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;">
                        {% else %}
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: #e2e8f0; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 24px;">
                                ðŸ‘¤
                            </div>
                        {% endif %}
                        <strong style="display: block; margin-bottom: 4px;">{{ player.name }}</strong>
                        {% if player.role %}<small style="color: #718096;">{{ player.role }}</small>{% endif %}
                    </div>
                {% empty %}
                    <p style="text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;">No more players available from this team</p>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>{{ session.match.team_b.name }} Players</h3>
            </div>
            <div class="player-list" id="team-b-players-list">
                {% for player in team_b_available %}
                    <div class="player-card" data-player-id="{{ player.id }}" onclick="pickPlayer({{ player.id }})">
                        {% if player.picture %}
                            <img src="{{ player.picture.url }}" alt="{{ player.name }}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;">
                        {% else %}
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: #e2e8f0; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 24px;">
                                ðŸ‘¤
                            </div>
                        {% endif %}
                        <strong style="display: block; margin-bottom: 4px;">{{ player.name }}</strong>
                        {% if player.role %}<small style="color: #718096;">{{ player.role }}</small>{% endif %}
                    </div>
                {% empty %}
                    <p style="text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;">No more players available from this team</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Selected Players Display -->
    <div class="card" id="selected-players-card">
        <div class="card-header">
            <h3>Selected Players</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div id="better-a-picks">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568;">{{ session.better_a.username }}</h4>
                <div id="better-a-picks-list">
                    {% for pick in better_a_picks %}
                        <span class="badge badge-info" data-player-id="{{ pick.player.id }}" style="margin: 4px 4px 4px 0; display: inline-block; animation: fadeIn 0.3s ease-in;">{{ pick.player.name }}</span>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px;">No players selected yet</p>
                    {% endfor %}
                </div>
            </div>
            <div id="better-b-picks">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568;">{{ session.better_b.username }}</h4>
                <div id="better-b-picks-list">
                    {% for pick in better_b_picks %}
                        <span class="badge badge-info" data-player-id="{{ pick.player.id }}" style="margin: 4px 4px 4px 0; display: inline-block; animation: fadeIn 0.3s ease-in;">{{ pick.player.name }}</span>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px;">No players selected yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Step 3: Betting -->
{% if session.status == 'betting' %}
    <div class="card" style="background: #fffaf0; border-color: #ed8936;">
        <h3 style="margin: 0 0 12px 0;">Place Your Bets</h3>
        <p style="margin: 0; color: #7c2d12;">Enter the amount you want to bet per run for each of your players. If your player scores 50 runs and you bet â‚¹10 per run, you win â‚¹500.</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Your Players - Place Bets</h3>
        </div>
        {% if session.better_a == user %}
            {% for pick in better_a_picks %}
                <div class="card" style="padding: 16px; margin-bottom: 12px; {% if pick.bet %}background: #f0fff4; border-color: #48bb78;{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <strong style="font-size: 16px; display: block; margin-bottom: 4px;">{{ pick.player.name }}</strong>
                            <span style="color: #718096; font-size: 13px;">{{ pick.player.team.name }}</span>
                        </div>
                        {% if pick.bet %}
                            <div style="text-align: right;">
                                <div style="font-size: 20px; color: #48bb78; font-weight: 600;">â‚¹{{ pick.bet.amount_per_run }}/run</div>
                                <span class="badge badge-success" style="margin-top: 4px; display: inline-block;">Bet Placed</span>
                            </div>
                        {% else %}
                            <div style="display: flex; gap: 8px; align-items: center; flex: 1; min-width: 200px;">
                                <input type="number" id="bet_amount_{{ pick.id }}" placeholder="Amount" min="0.01" step="0.01" class="form-control" style="flex: 1;">
                                <button onclick="placeBet({{ pick.id }})" class="btn">Place Bet</button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            {% for pick in better_b_picks %}
                <div class="card" style="padding: 16px; margin-bottom: 12px; {% if pick.bet %}background: #f0fff4; border-color: #48bb78;{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <strong style="font-size: 16px; display: block; margin-bottom: 4px;">{{ pick.player.name }}</strong>
                            <span style="color: #718096; font-size: 13px;">{{ pick.player.team.name }}</span>
                        </div>
                        {% if pick.bet %}
                            <div style="text-align: right;">
                                <div style="font-size: 20px; color: #48bb78; font-weight: 600;">â‚¹{{ pick.bet.amount_per_run }}/run</div>
                                <span class="badge badge-success" style="margin-top: 4px; display: inline-block;">Bet Placed</span>
                            </div>
                        {% else %}
                            <div style="display: flex; gap: 8px; align-items: center; flex: 1; min-width: 200px;">
                                <input type="number" id="bet_amount_{{ pick.id }}" placeholder="Amount" min="0.01" step="0.01" class="form-control" style="flex: 1;">
                                <button onclick="placeBet({{ pick.id }})" class="btn">Place Bet</button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Opponent's Bets -->
    <div class="card">
        <div class="card-header">
            <h3>Opponent's Bets</h3>
        </div>
        {% if session.better_a == user %}
            {% for pick in better_b_picks %}
                <div class="card" style="padding: 16px; margin-bottom: 12px; {% if not pick.bet %}opacity: 0.6;{% endif %}">
                    <div>
                        <strong style="font-size: 16px; display: block; margin-bottom: 4px;">{{ pick.player.name }}</strong>
                        <span style="color: #718096; font-size: 13px;">{{ pick.player.team.name }}</span>
                    </div>
                    {% if pick.bet %}
                        <div style="margin-top: 8px; color: #48bb78; font-weight: 600;">â‚¹{{ pick.bet.amount_per_run }}/run</div>
                    {% else %}
                        <div style="margin-top: 8px; color: #718096;">Waiting for bet...</div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            {% for pick in better_a_picks %}
                <div class="card" style="padding: 16px; margin-bottom: 12px; {% if not pick.bet %}opacity: 0.6;{% endif %}">
                    <div>
                        <strong style="font-size: 16px; display: block; margin-bottom: 4px;">{{ pick.player.name }}</strong>
                        <span style="color: #718096; font-size: 13px;">{{ pick.player.team.name }}</span>
                    </div>
                    {% if pick.bet %}
                        <div style="margin-top: 8px; color: #48bb78; font-weight: 600;">â‚¹{{ pick.bet.amount_per_run }}/run</div>
                    {% else %}
                        <div style="margin-top: 8px; color: #718096;">Waiting for bet...</div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    </div>
{% endif %}

<!-- Step 4: Results -->
{% if session.status == 'completed' %}
    <div class="card" style="background: #f0fff4; border-color: #48bb78;">
        <h3 style="margin: 0 0 12px 0;">Match Complete</h3>
        <p style="margin: 0; color: #22543d;">Here are your final results.</p>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Final Winnings</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="text-align: center; padding: 24px; background: #f7fafc; border-radius: 6px;">
                <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">{{ session.better_a.username }}</div>
                <div style="font-size: 32px; font-weight: 600; color: #48bb78;">â‚¹{{ session.better_a_total_winnings }}</div>
            </div>
            <div style="text-align: center; padding: 24px; background: #f7fafc; border-radius: 6px;">
                <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">{{ session.better_b.username }}</div>
                <div style="font-size: 32px; font-weight: 600; color: #48bb78;">â‚¹{{ session.better_b_total_winnings }}</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Detailed Results</h3>
        </div>
        <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Runs</th>
                    <th>Bet Amount</th>
                    <th>Winnings</th>
                </tr>
            </thead>
            <tbody>
                {% if session.better_a == user %}
                    {% for bet in better_a_bets %}
                        <tr>
                            <td><strong>{{ bet.picked_player.player.name }}</strong></td>
                            <td>{{ bet.runs_scored|default:"-" }}</td>
                            <td>â‚¹{{ bet.amount_per_run }}/run</td>
                            <td style="color: #48bb78; font-weight: 600;">â‚¹{{ bet.total_payout|default:"-" }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    {% for bet in better_b_bets %}
                        <tr>
                            <td><strong>{{ bet.picked_player.player.name }}</strong></td>
                            <td>{{ bet.runs_scored|default:"-" }}</td>
                            <td>â‚¹{{ bet.amount_per_run }}/run</td>
                            <td style="color: #48bb78; font-weight: 600;">â‚¹{{ bet.total_payout|default:"-" }}</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        </div>
    </div>
{% elif session.match.status == 'completed' and session.status == 'betting' %}
    <div class="card" style="background: #fffaf0; border-color: #ed8936;">
        <h3 style="margin: 0 0 12px 0;">Match Finished</h3>
        <p style="margin: 0 0 16px 0; color: #7c2d12;">The match is over. Click below to calculate your winnings.</p>
        <form method="post" action="{% url 'core:settle_session' session.id %}">
            {% csrf_token %}
            <button type="submit" class="btn">Calculate Results</button>
        </form>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Confirm</h3>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" id="confirmBtn" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>

<script>
let pendingAction = null;
let pendingData = null;

function pickPlayer(playerId) {
    const playerCard = event.target.closest('.player-card');
    const playerName = playerCard.querySelector('strong').textContent;
    
    pendingAction = 'pick';
    pendingData = {player_id: playerId};
    
    document.getElementById('modalTitle').textContent = 'Select Player?';
    document.getElementById('modalBody').innerHTML = `
        <p>Do you want to pick <strong>${playerName}</strong>?</p>
        <p style="color: #718096; font-size: 13px; margin-top: 8px;">This cannot be changed later.</p>
    `;
    document.getElementById('confirmBtn').textContent = 'Yes, Pick This Player';
    document.getElementById('confirmBtn').onclick = confirmPick;
    document.getElementById('confirmModal').style.display = 'block';
}

function confirmPick() {
    if (!pendingData) return;
    
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Picking...';
    
    fetch(`{% url 'core:pick_player' session.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(pendingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #48bb78; font-size: 14px;">Player selected successfully!</p>
                <p style="color: #718096; font-size: 12px; margin-top: 8px;">${data.picked_player_name} has been picked.</p>
            `;
            confirmBtn.style.display = 'none';
            
            // Update last update time
            if (data.updated_at) {
                lastUpdateTime = data.updated_at;
            }
            
            // Reload after short delay to show updated state
            setTimeout(() => {
                closeModal();
                location.reload();
            }, 800);
        } else {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #f56565;">Error: ${data.error}</p>
            `;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Close';
            confirmBtn.onclick = closeModal;
        }
    })
    .catch(error => {
        document.getElementById('modalBody').innerHTML = `
            <p style="color: #f56565;">Something went wrong. Please try again.</p>
        `;
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Close';
        confirmBtn.onclick = closeModal;
    });
}

function placeBet(pickedPlayerId) {
    const amountInput = document.getElementById('bet_amount_' + pickedPlayerId);
    const amount = parseFloat(amountInput.value);
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount (e.g., 10)');
        return;
    }
    
    const row = amountInput.closest('.card');
    const playerName = row.querySelector('strong').textContent;
    
    pendingAction = 'bet';
    pendingData = {
        picked_player_id: pickedPlayerId,
        amount_per_run: amount,
        insurance_percentage: 0
    };
    
    document.getElementById('modalTitle').textContent = 'Place Bet?';
    document.getElementById('modalBody').innerHTML = `
        <p>Bet <strong>â‚¹${amount}</strong> per run on <strong>${playerName}</strong>?</p>
        <p style="color: #718096; font-size: 13px; margin-top: 8px;">
            Example: If they score 50 runs, you win â‚¹${(amount * 50).toFixed(2)}
        </p>
    `;
    document.getElementById('confirmBtn').textContent = 'Yes, Place Bet';
    document.getElementById('confirmBtn').onclick = confirmBet;
    document.getElementById('confirmBtn').disabled = false;
    document.getElementById('confirmModal').style.display = 'block';
}

function confirmBet() {
    if (!pendingData) return;
    
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Placing Bet...';
    
    fetch(`{% url 'core:place_bet' session.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(pendingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #48bb78; font-size: 14px;">${data.message}</p>
            `;
            confirmBtn.style.display = 'none';
            setTimeout(() => {
                closeModal();
                location.reload();
            }, 1000);
        } else {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #f56565;">Error: ${data.error}</p>
            `;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Close';
            confirmBtn.onclick = closeModal;
        }
    })
    .catch(error => {
        document.getElementById('modalBody').innerHTML = `
            <p style="color: #f56565;">Something went wrong. Please try again.</p>
        `;
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Close';
        confirmBtn.onclick = closeModal;
    });
}

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
    pendingData = null;
}

function confirmAction() {
    if (pendingAction === 'pick') confirmPick();
    else if (pendingAction === 'bet') confirmBet();
}

{% if session.status == 'picking' %}
// Real-time session updates
let pollingInterval = null;
let lastUpdateTime = '{{ session.updated_at.isoformat }}';
let updateCheckInProgress = false;
const turnIndicator = document.getElementById('turn-indicator');
const currentTurnUserId = {% if session.current_turn %}{{ session.current_turn.id }}{% else %}null{% endif %};
const currentUserId = {{ user.id }};

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

function showNotification(title, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: '/static/favicon.ico',
            tag: 'session-update',
            requireInteraction: false
        });
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? '#48bb78' : type === 'warning' ? '#ed8936' : '#4299e1';
    toast.style.cssText = `
        background: ${bgColor};
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease-out;
        cursor: pointer;
    `;
    toast.textContent = message;
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }
    `;
    if (!document.getElementById('toast-styles')) {
        style.id = 'toast-styles';
        document.head.appendChild(style);
    }
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 4000);
    
    // Click to dismiss
    toast.addEventListener('click', () => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
}

function updateSelectedPlayers(data) {
    const betterAPicksList = document.getElementById('better-a-picks-list');
    const betterBPicksList = document.getElementById('better-b-picks-list');
    
    if (!betterAPicksList || !betterBPicksList) return;
    
    // Update better A picks
    const currentBetterAPicks = Array.from(betterAPicksList.querySelectorAll('[data-player-id]')).map(el => parseInt(el.dataset.playerId));
    const newBetterAPicks = data.better_a_picks.map(p => p.player_id);
    
    // Remove players that are no longer picked (shouldn't happen, but handle it)
    currentBetterAPicks.forEach(playerId => {
        if (!newBetterAPicks.includes(playerId)) {
            const badge = betterAPicksList.querySelector(`[data-player-id="${playerId}"]`);
            if (badge) {
                badge.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => badge.remove(), 300);
            }
        }
    });
    
    // Add new players
    newBetterAPicks.forEach(playerId => {
        if (!currentBetterAPicks.includes(playerId)) {
            const pick = data.better_a_picks.find(p => p.player_id === playerId);
            if (pick) {
                const badge = document.createElement('span');
                badge.className = 'badge badge-info';
                badge.dataset.playerId = playerId;
                badge.textContent = pick.player_name;
                badge.style.cssText = 'margin: 4px 4px 4px 0; display: inline-block; animation: fadeIn 0.3s ease-in;';
                betterAPicksList.appendChild(badge);
                
                // If list was empty, remove the empty message
                const emptyMsg = betterAPicksList.querySelector('p');
                if (emptyMsg) emptyMsg.remove();
            }
        }
    });
    
    // Update better B picks
    const currentBetterBPicks = Array.from(betterBPicksList.querySelectorAll('[data-player-id]')).map(el => parseInt(el.dataset.playerId));
    const newBetterBPicks = data.better_b_picks.map(p => p.player_id);
    
    // Remove players that are no longer picked
    currentBetterBPicks.forEach(playerId => {
        if (!newBetterBPicks.includes(playerId)) {
            const badge = betterBPicksList.querySelector(`[data-player-id="${playerId}"]`);
            if (badge) {
                badge.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => badge.remove(), 300);
            }
        }
    });
    
    // Add new players
    newBetterBPicks.forEach(playerId => {
        if (!currentBetterBPicks.includes(playerId)) {
            const pick = data.better_b_picks.find(p => p.player_id === playerId);
            if (pick) {
                const badge = document.createElement('span');
                badge.className = 'badge badge-info';
                badge.dataset.playerId = playerId;
                badge.textContent = pick.player_name;
                badge.style.cssText = 'margin: 4px 4px 4px 0; display: inline-block; animation: fadeIn 0.3s ease-in;';
                betterBPicksList.appendChild(badge);
                
                // If list was empty, remove the empty message
                const emptyMsg = betterBPicksList.querySelector('p');
                if (emptyMsg) emptyMsg.remove();
            }
        }
    });
    
    // If both lists are empty, add empty messages
    if (betterAPicksList.children.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.cssText = 'color: #718096; font-size: 13px;';
        emptyMsg.textContent = 'No players selected yet';
        betterAPicksList.appendChild(emptyMsg);
    }
    if (betterBPicksList.children.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.cssText = 'color: #718096; font-size: 13px;';
        emptyMsg.textContent = 'No players selected yet';
        betterBPicksList.appendChild(emptyMsg);
    }
}

function updateProgress(data) {
    const isBetterA = {{ session.better_a.id }} === currentUserId;
    
    // Update team counts
    if (isBetterA) {
        document.getElementById('team-a-progress').textContent = `${data.better_a_team_a_count}/{{ session.players_per_side }}`;
        document.getElementById('team-b-progress').textContent = `${data.better_a_team_b_count}/{{ session.players_per_side }}`;
        document.getElementById('total-picked').textContent = data.better_a_picks_count;
    } else {
        document.getElementById('team-a-progress').textContent = `${data.better_b_team_a_count}/{{ session.players_per_side }}`;
        document.getElementById('team-b-progress').textContent = `${data.better_b_team_b_count}/{{ session.players_per_side }}`;
        document.getElementById('total-picked').textContent = data.better_b_picks_count;
    }
    
    // Add pulse animation when count changes
    const teamAProgress = document.getElementById('team-a-progress');
    const teamBProgress = document.getElementById('team-b-progress');
    teamAProgress.style.transform = 'scale(1.1)';
    teamBProgress.style.transform = 'scale(1.1)';
    setTimeout(() => {
        teamAProgress.style.transform = 'scale(1)';
        teamBProgress.style.transform = 'scale(1)';
    }, 300);
}

function removePickedPlayersFromAvailable(data) {
    // Get all picked player IDs
    const allPickedIds = new Set();
    data.better_a_picks.forEach(p => allPickedIds.add(p.player_id));
    data.better_b_picks.forEach(p => allPickedIds.add(p.player_id));
    
    // Remove from team A list
    const teamAList = document.getElementById('team-a-players-list');
    if (teamAList) {
        const teamACards = teamAList.querySelectorAll('.player-card[data-player-id]');
        teamACards.forEach(card => {
            const playerId = parseInt(card.dataset.playerId);
            if (allPickedIds.has(playerId)) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.remove();
                    // Check if list is empty
                    if (teamAList.querySelectorAll('.player-card').length === 0) {
                        const emptyMsg = document.createElement('p');
                        emptyMsg.style.cssText = 'text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;';
                        emptyMsg.textContent = 'No more players available from this team';
                        teamAList.appendChild(emptyMsg);
                    }
                }, 300);
            }
        });
    }
    
    // Remove from team B list
    const teamBList = document.getElementById('team-b-players-list');
    if (teamBList) {
        const teamBCards = teamBList.querySelectorAll('.player-card[data-player-id]');
        teamBCards.forEach(card => {
            const playerId = parseInt(card.dataset.playerId);
            if (allPickedIds.has(playerId)) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.remove();
                    // Check if list is empty
                    if (teamBList.querySelectorAll('.player-card').length === 0) {
                        const emptyMsg = document.createElement('p');
                        emptyMsg.style.cssText = 'text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;';
                        emptyMsg.textContent = 'No more players available from this team';
                        teamBList.appendChild(emptyMsg);
                    }
                }, 300);
            }
        });
    }
}

function updateSessionState(data) {
    // Update turn indicator
    if (turnIndicator) {
        const isMyTurn = data.is_my_turn;
        const currentTurnUsername = data.current_turn || 'Waiting...';
        
        if (isMyTurn) {
            turnIndicator.innerHTML = `
                <div style="background: #ebf8ff; padding: 16px; border-radius: 6px; border-left: 4px solid #4299e1;">
                    <h3 style="margin: 0 0 8px 0; color: #2c5282;">Your Turn</h3>
                    <p style="margin: 0; color: #2c5282;">Select a player from either team below. You need to pick {{ session.players_per_side }} players from each team.</p>
                </div>
            `;
            
            // Show notification if it just became your turn
            if (turnIndicator.dataset.isMyTurn !== 'true') {
                showNotification('Your Turn!', 'It\'s your turn to pick a player');
                showToast('ðŸŽ¯ It\'s your turn to pick a player!', 'success');
            }
        } else {
            turnIndicator.innerHTML = `
                <div style="background: #fffaf0; padding: 16px; border-radius: 6px; border-left: 4px solid #ed8936;">
                    <h3 style="margin: 0 0 8px 0; color: #7c2d12;">Waiting</h3>
                    <p style="margin: 0; color: #7c2d12;">Waiting for <strong>${currentTurnUsername}</strong> to pick a player. This page will update automatically.</p>
                </div>
            `;
        }
        turnIndicator.dataset.isMyTurn = isMyTurn;
    }
    
    // Update selected players list smoothly
    updateSelectedPlayers(data);
    
    // Update progress counters
    updateProgress(data);
    
    // Remove picked players from available list (if it's your turn)
    if (data.is_my_turn) {
        removePickedPlayersFromAvailable(data);
    }
    
    // Show notification for opponent's picks
    if (data.recent_picks && data.recent_picks.length > 0) {
        data.recent_picks.forEach(pick => {
            if (pick.is_opponent && pick.picked_at > lastUpdateTime) {
                const message = `${pick.better_username} picked ${pick.player_name}`;
                showNotification('Player Picked!', message);
                showToast(`ðŸ‘¤ ${message}`, 'info');
            }
        });
    }
    
    // Update last update time
    lastUpdateTime = data.updated_at;
    
    // If status changed or picks completed, reload page for full update
    if (data.status !== '{{ session.status }}' || data.picks_completed) {
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

function checkForUpdates() {
    if (updateCheckInProgress || document.visibilityState !== 'visible') {
        return;
    }
    
    updateCheckInProgress = true;
    
    fetch(`{% url 'core:check_session_updates' session.id %}?last_update=${encodeURIComponent(lastUpdateTime)}`, {
        headers: {
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        updateCheckInProgress = false;
        
        if (data.session_updated) {
            updateSessionState(data);
            
            // If it's now my turn, reload to show player selection
            if (data.is_my_turn && turnIndicator && turnIndicator.dataset.isMyTurn !== 'true') {
                // Small delay to show the notification first
                setTimeout(() => {
                    location.reload();
                }, 800);
            }
        }
    })
    .catch(error => {
        updateCheckInProgress = false;
        console.error('Error checking for updates:', error);
    });
}

// Start polling when page is visible
// Poll more frequently when it's not your turn to catch opponent's picks quickly
if (turnIndicator) {
    // Check immediately
    checkForUpdates();
    
    // Poll every 1.5 seconds for very responsive updates
    pollingInterval = setInterval(checkForUpdates, 1500);
    
    // Also check when page becomes visible
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            checkForUpdates();
        }
    });
}

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});
{% endif %}
</script>
{% endblock %}
