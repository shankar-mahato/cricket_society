{% extends 'core/base.html' %}

{% block title %}Session #{{ session.id }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Betting Session #{{ session.id }}</h1>
    <p>{{ session.match.team_a.name }} vs {{ session.match.team_b.name }}</p>
</div>

<!-- Match Info Card -->
<div class="card">
    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        {% if session.match.team_a.logo %}
            <img src="{{ session.match.team_a.logo.url }}" alt="{{ session.match.team_a.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% elif session.match.team_a.logo_url %}
            <img src="{{ session.match.team_a.logo_url }}" alt="{{ session.match.team_a.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% else %}
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-weight: 600;">
                {{ session.match.team_a.name|first|upper }}
            </div>
        {% endif %}
        <div style="flex: 1;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">{{ session.match.team_a.name }} vs {{ session.match.team_b.name }}</h3>
            <p style="margin: 4px 0 0 0; color: #718096; font-size: 14px;">{{ session.match.match_title }}</p>
        </div>
        {% if session.match.team_b.logo %}
            <img src="{{ session.match.team_b.logo.url }}" alt="{{ session.match.team_b.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% elif session.match.team_b.logo_url %}
            <img src="{{ session.match.team_b.logo_url }}" alt="{{ session.match.team_b.name }}" style="width: 48px; height: 48px; object-fit: contain;">
        {% else %}
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-weight: 600;">
                {{ session.match.team_b.name|first|upper }}
            </div>
        {% endif %}
    </div>
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; display: flex; gap: 16px; flex-wrap: wrap;">
        <div>
            <span style="color: #718096; font-size: 13px;">Status:</span>
            <span class="status-badge {% if session.status == 'completed' %}status-completed{% elif session.status == 'betting' %}status-warning{% else %}status-info{% endif %}" style="margin-left: 8px;">
                {{ session.get_status_display }}
            </span>
        </div>
        <div>
            <span style="color: #718096; font-size: 13px;">Players per side:</span>
            <strong style="margin-left: 8px;">{{ session.players_per_side }}</strong>
        </div>
    </div>
</div>

<!-- Progress Steps -->
<div class="card">
    <div class="progress-steps">
        <div class="progress-step {% if session.status == 'pending' %}active{% elif session.status != 'pending' %}completed{% endif %}">
            <div class="progress-step-circle">1</div>
            <div class="progress-step-label">Join</div>
        </div>
        <div class="progress-step {% if session.status == 'picking' %}active{% elif session.status == 'betting' or session.status == 'completed' %}completed{% endif %}">
            <div class="progress-step-circle">2</div>
            <div class="progress-step-label">Pick Players</div>
        </div>
        <div class="progress-step {% if session.status == 'betting' or session.status == 'completed' %}active{% endif %}">
            <div class="progress-step-circle">3</div>
            <div class="progress-step-label">Results</div>
        </div>
    </div>
</div>

<!-- Step 1: Waiting for Player / Toss -->
{% if session.status == 'pending' %}
    {% if session.better_b == session.better_a %}
        <div class="card" style="background: #ebf8ff; border-color: #4299e1;">
            <h3 style="margin: 0 0 12px 0;">Waiting for Opponent</h3>
            <p style="margin: 0 0 16px 0; color: #2c5282;">Invite a friend to join your betting session. Session ID: <strong>#{{ session.id }}</strong></p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{% url 'core:send_invite' session.id %}" class="btn" style="background: #4299e1; color: white;">üìß Invite Friend</a>
                <a href="{% url 'core:my_invites' %}" class="btn" style="background: #718096; color: white;">View My Invites</a>
            </div>
        </div>
    {% elif can_perform_toss and not toss_completed %}
        <div class="card" id="toss-card" style="background: #fffaf0; border-color: #ed8936;">
            <h3 style="margin: 0 0 12px 0;">Toss Required</h3>
            <p style="margin: 0 0 16px 0; color: #7c2d12;">Both players have joined. Perform the toss to determine who picks first.</p>
            <button onclick="performToss()" class="btn" id="toss-btn">Perform Toss</button>
        </div>
    {% endif %}
{% endif %}

<div id="toss-result-card" style="display: none;" class="card" style="background: #f0fff4; border-color: #48bb78;">
    <p style="margin: 0; color: #22543d;">
        <strong>Toss Winner:</strong> <strong id="toss-winner-name"></strong> will pick first.
    </p>
</div>

{% if toss_completed and better_a_picks|length == 0 and better_b_picks|length == 0 %}
    <div class="card" id="toss-winner-banner" style="background: #f0fff4; border-color: #48bb78;">
        <p style="margin: 0; color: #22543d;">
            <strong>Toss Winner:</strong> <strong>{{ toss_winner.username }}</strong> will pick first.
        </p>
    </div>
{% endif %}

<!-- Step 2: Picking Players -->
{% if session.status == 'picking' %}
    <!-- Toast notification container -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 350px;"></div>
    
    <div class="card" id="turn-indicator" data-is-my-turn="{% if is_my_turn %}true{% else %}false{% endif %}" data-current-turn-user="{{ session.current_turn.username|default:'' }}">
        {% if is_my_turn %}
            <div style="background: #ebf8ff; padding: 16px; border-radius: 6px; border-left: 4px solid #4299e1;">
                <h3 style="margin: 0 0 8px 0; color: #2c5282;">Your Turn</h3>
                <p style="margin: 0; color: #2c5282;">Select a player from either team below. You need to pick {{ session.players_per_side }} players from each team.</p>
            </div>
        {% else %}
            <div style="background: #fffaf0; padding: 16px; border-radius: 6px; border-left: 4px solid #ed8936;">
                <h3 style="margin: 0 0 8px 0; color: #7c2d12;">Waiting</h3>
                <p style="margin: 0; color: #7c2d12;">Waiting for <strong>{{ session.current_turn.username }}</strong> to pick a player. This page will update automatically.</p>
                <p style="margin: 8px 0 0 0; color: #7c2d12; font-size: 12px;">üîî You'll be notified when it's your turn</p>
            </div>
        {% endif %}
    </div>

    <!-- Player Selection Progress -->
    <div class="card" id="progress-card">
        <div class="card-header">
            <h3>Your Progress</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div style="text-align: center; padding: 20px; background: #f7fafc; border-radius: 6px;">
                <div id="team-a-progress" style="font-size: 32px; font-weight: 600; color: #4299e1; transition: all 0.3s ease;">
                    {% if session.better_a == user %}{{ better_a_team_a_count }}{% else %}{{ better_b_team_a_count }}{% endif %}/{{ session.players_per_side }}
                </div>
                <div style="color: #718096; margin-top: 8px; font-size: 14px;">{{ session.match.team_a.name }}</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #f7fafc; border-radius: 6px;">
                <div id="team-b-progress" style="font-size: 32px; font-weight: 600; color: #4299e1; transition: all 0.3s ease;">
                    {% if session.better_a == user %}{{ better_a_team_b_count }}{% else %}{{ better_b_team_b_count }}{% endif %}/{{ session.players_per_side }}
                </div>
                <div style="color: #718096; margin-top: 8px; font-size: 14px;">{{ session.match.team_b.name }}</div>
            </div>
        </div>
        <div style="text-align: center; padding: 12px; background: #ebf8ff; border-radius: 6px; color: #2c5282;">
            <strong>Total Picked:</strong> 
            <span id="total-picked">
            {% if session.better_a == user %}
                {{ better_a_picks|length }}
            {% else %}
                {{ better_b_picks|length }}
            {% endif %}
            </span>
            /{{ session.players_per_side|add:session.players_per_side }}
        </div>
    </div>

    <!-- Available Players -->
    {% if is_my_turn %}
        <div class="card">
            <div class="card-header">
                <h3>{{ session.match.team_a.name }} Players</h3>
            </div>
            <div class="player-list" id="team-a-players-list">
                {% for player in team_a_available %}
                    <div class="player-card" data-player-id="{{ player.id }}" onclick="pickPlayer({{ player.id }})">
                        {% if player.picture %}
                            <img src="{{ player.picture.url }}" alt="{{ player.name }}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;">
                        {% else %}
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: #e2e8f0; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 24px;">
                                üë§
                            </div>
                        {% endif %}
                        <strong style="display: block; margin-bottom: 4px;">{{ player.name }}</strong>
                        {% if player.role %}<small style="color: #718096;">{{ player.role }}</small>{% endif %}
                    </div>
                {% empty %}
                    <p style="text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;">No more players available from this team</p>
                {% endfor %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>{{ session.match.team_b.name }} Players</h3>
            </div>
            <div class="player-list" id="team-b-players-list">
                {% for player in team_b_available %}
                    <div class="player-card" data-player-id="{{ player.id }}" onclick="pickPlayer({{ player.id }})">
                        {% if player.picture %}
                            <img src="{{ player.picture.url }}" alt="{{ player.name }}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 8px;">
                        {% else %}
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: #e2e8f0; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 24px;">
                                üë§
                            </div>
                        {% endif %}
                        <strong style="display: block; margin-bottom: 4px;">{{ player.name }}</strong>
                        {% if player.role %}<small style="color: #718096;">{{ player.role }}</small>{% endif %}
                    </div>
                {% empty %}
                    <p style="text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;">No more players available from this team</p>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <script>
    // Auto-scroll to players list on mobile after page load if it's user's turn
    (function() {
        {% if is_my_turn %}
        if (window.innerWidth <= 768) {
            setTimeout(function() {
                const playersCard = document.querySelector('.card:has(.player-list)');
                if (playersCard) {
                    playersCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500);
        }
        {% endif %}
    })();
    </script>

    <!-- Selected Players Display - Side by Side -->
    <div class="card" id="selected-players-card">
        <div class="card-header">
            <h3>Selected Players</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div id="better-a-picks">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568;">{{ session.better_a.username }}</h4>
                <div id="better-a-picks-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% for pick in better_a_picks %}
                        <div class="player-badge" data-player-id="{{ pick.player.id }}" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #ebf8ff; border-radius: 6px; border: 1px solid #4299e1; animation: fadeIn 0.3s ease-in;">
                            {% if pick.player.picture %}
                                <img src="{{ pick.player.picture.url }}" alt="{{ pick.player.name }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 14px;">üë§</div>
                            {% endif %}
                            <span style="font-weight: 500; color: #2c5282;">{{ pick.player.name }}</span>
                        </div>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px;">No players selected yet</p>
                    {% endfor %}
                </div>
            </div>
            <div id="better-b-picks">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568;">{{ session.better_b.username }}</h4>
                <div id="better-b-picks-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% for pick in better_b_picks %}
                        <div class="player-badge" data-player-id="{{ pick.player.id }}" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff5e6; border-radius: 6px; border: 1px solid #ed8936; animation: fadeIn 0.3s ease-in;">
                            {% if pick.player.picture %}
                                <img src="{{ pick.player.picture.url }}" alt="{{ pick.player.name }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 14px;">üë§</div>
                            {% endif %}
                            <span style="font-weight: 500; color: #7c2d12;">{{ pick.player.name }}</span>
                        </div>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px;">No players selected yet</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}

<!-- Step 3: Betting -->
{% if session.status == 'betting' %}
    <div class="card" style="background: #fffaf0; border-color: #ed8936;">
        <h3 style="margin: 0 0 12px 0;">Betting Information</h3>
        <p style="margin: 0; color: #7c2d12;">Fixed amount per run: <strong>‚Çπ{{ session.fixed_bet_amount }}</strong></p>
        <p style="margin: 8px 0 0 0; color: #7c2d12; font-size: 13px;">Winner gets difference of total runs scored by the players from both the team √ó ‚Çπ{{ session.fixed_bet_amount }}.</p>
    </div>

    <!-- Selected Players Display - Side by Side -->
    <div class="card">
        <div class="card-header">
            <h3>Selected Players</h3>
            <p style="margin: 8px 0 0 0; color: #718096; font-size: 13px;">Both players' selections</p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: #4299e1;"></span>
                    {{ session.better_a.username }}
                </h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            {% for pick in better_a_picks %}
                        <div class="player-badge" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #ebf8ff; border-radius: 6px; border: 1px solid #4299e1;">
                            {% if pick.player.picture %}
                                <img src="{{ pick.player.picture.url }}" alt="{{ pick.player.name }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 14px;">üë§</div>
                            {% endif %}
                            <span style="font-weight: 500; color: #2c5282;">{{ pick.player.name }}</span>
                        </div>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px; margin: 0;">No players selected</p>
                    {% endfor %}
                </div>
            </div>
                        <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: #ed8936;"></span>
                    {{ session.better_b.username }}
                </h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% for pick in better_b_picks %}
                        <div class="player-badge" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff5e6; border-radius: 6px; border: 1px solid #ed8936;">
                            {% if pick.player.picture %}
                                <img src="{{ pick.player.picture.url }}" alt="{{ pick.player.name }}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 14px;">üë§</div>
                            {% endif %}
                            <span style="font-weight: 500; color: #7c2d12;">{{ pick.player.name }}</span>
                        </div>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px; margin: 0;">No players selected</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
        
        {% if session.better_a == user %}
            {% if better_a_bets.exists %}
                <!-- Match Status Based Actions -->
                {% if session.match.status == 'upcoming' %}
                    <div style="padding: 20px; background: #f7fafc; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                        <div style="font-size: 16px; color: #718096; margin-bottom: 8px;">‚è∞ Match is yet to start</div>
                        <div style="color: #4a5568; font-size: 14px;">The match has not begun yet. Check back later!</div>
                    </div>
                {% elif session.match.status == 'live' %}
                    <div style="padding: 20px; background: #fffaf0; border-radius: 6px; border: 1px solid #ed8936; text-align: center;">
                        <div style="font-size: 16px; color: #7c2d12; font-weight: 600; margin-bottom: 12px;">‚ö° Match in Progress</div>
                        <button onclick="openStandingsModal()" class="btn" style="background: #ed8936; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer;">View Current Standings</button>
                    </div>
                {% elif session.match.status == 'completed' and session.status != 'completed' %}
                    <div style="padding: 20px; background: #fffaf0; border-radius: 6px; border: 1px solid #ed8936; text-align: center;">
                        <div style="font-size: 16px; color: #7c2d12; font-weight: 600; margin-bottom: 12px;">üèÅ Match Finished</div>
                        <form method="post" action="{% url 'core:settle_session' session.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn" style="background: #4299e1; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer;">Calculate Results</button>
                        </form>
                            </div>
                        {% else %}
                    <div style="padding: 16px; background: #f0fff4; border-radius: 6px; border: 1px solid #48bb78; text-align: center;">
                        <div style="font-size: 18px; color: #48bb78; font-weight: 600; margin-bottom: 8px;">‚úì Bet Placed Automatically</div>
                        <div style="color: #22543d; font-size: 14px;">Your bet of ‚Çπ{{ session.fixed_bet_amount }} per run has been placed automatically</div>
                            </div>
                        {% endif %}
            {% else %}
                <div style="text-align: center; padding: 20px;">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 24px; font-weight: 600; color: #4a5568; margin-bottom: 8px;">‚Çπ{{ session.fixed_bet_amount }}</div>
                        <div style="color: #718096; font-size: 14px;">Fixed Amount Per Run</div>
                        <div style="color: #718096; font-size: 12px; margin-top: 4px;">Bet will be placed automatically when all players are picked</div>
                    </div>
                </div>
            {% endif %}
        {% else %}
            {% if better_b_bets.exists %}
                <!-- Match Status Based Actions -->
                {% if session.match.status == 'upcoming' %}
                    <div style="padding: 20px; background: #f7fafc; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                        <div style="font-size: 16px; color: #718096; margin-bottom: 8px;">‚è∞ Match is yet to start</div>
                        <div style="color: #4a5568; font-size: 14px;">The match has not begun yet. Check back later!</div>
                    </div>
                {% elif session.match.status == 'live' %}
                    <div style="padding: 20px; background: #fffaf0; border-radius: 6px; border: 1px solid #ed8936; text-align: center;">
                        <div style="font-size: 16px; color: #7c2d12; font-weight: 600; margin-bottom: 12px;">‚ö° Match in Progress</div>
                        <button onclick="openStandingsModal()" class="btn" style="background: #ed8936; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer;">View Current Standings</button>
                    </div>
                {% elif session.match.status == 'completed' and session.status != 'completed' %}
                    <div style="padding: 20px; background: #fffaf0; border-radius: 6px; border: 1px solid #ed8936; text-align: center;">
                        <div style="font-size: 16px; color: #7c2d12; font-weight: 600; margin-bottom: 12px;">üèÅ Match Finished</div>
                        <form method="post" action="{% url 'core:settle_session' session.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn" style="background: #4299e1; color: white; padding: 12px 24px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer;">Calculate Results</button>
                        </form>
                    </div>
                {% else %}
                    <div style="padding: 16px; background: #f0fff4; border-radius: 6px; border: 1px solid #48bb78; text-align: center;">
                        <div style="font-size: 18px; color: #48bb78; font-weight: 600; margin-bottom: 8px;">‚úì Bet Placed Automatically</div>
                        <div style="color: #22543d; font-size: 14px;">Your bet of ‚Çπ{{ session.fixed_bet_amount }} per run has been placed automatically</div>
                    </div>
                {% endif %}
            {% else %}
                <div style="text-align: center; padding: 20px;">
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 24px; font-weight: 600; color: #4a5568; margin-bottom: 8px;">‚Çπ{{ session.fixed_bet_amount }}</div>
                        <div style="color: #718096; font-size: 14px;">Fixed Amount Per Run</div>
                        <div style="color: #718096; font-size: 12px; margin-top: 4px;">Bet will be placed automatically when all players are picked</div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    </div>

{% endif %}

<!-- Step 4: Results -->
{% if session.status == 'completed' %}
    <!-- Calculation Summary -->
    <div class="card" style="background: #f7fafc;">
        <div class="card-header">
            <h3>Calculation Summary</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="padding: 20px; background: white; border-radius: 6px; border: 2px solid #4299e1;">
                <div style="font-size: 12px; color: #718096; margin-bottom: 8px;">{{ session.better_a.username }}</div>
                <div style="font-size: 24px; font-weight: 600; color: #2c5282; margin-bottom: 4px;">
                    {{ better_a_total_runs }} runs
                </div>
                <div style="font-size: 14px; color: #4a5568;">
                    √ó ‚Çπ{{ session.fixed_bet_amount }} = 
                    <strong style="color: #4299e1;">‚Çπ{{ better_a_total_value|floatformat:2 }}</strong>
                </div>
            </div>
            <div style="padding: 20px; background: white; border-radius: 6px; border: 2px solid #ed8936;">
                <div style="font-size: 12px; color: #718096; margin-bottom: 8px;">{{ session.better_b.username }}</div>
                <div style="font-size: 24px; font-weight: 600; color: #7c2d12; margin-bottom: 4px;">
                    {{ better_b_total_runs }} runs
                </div>
                <div style="font-size: 14px; color: #4a5568;">
                    √ó ‚Çπ{{ session.fixed_bet_amount }} = 
                    <strong style="color: #ed8936;">‚Çπ{{ better_b_total_value|floatformat:2 }}</strong>
                </div>
            </div>
        </div>
        <div style="padding: 16px; background: #ebf8ff; border-radius: 6px; text-align: center;">
            <div style="font-size: 14px; color: #2c5282; margin-bottom: 8px;">Difference</div>
            <div style="font-size: 28px; font-weight: 700; color: #4299e1;">
                ‚Çπ{{ difference|floatformat:2 }}
            </div>
        </div>
    </div>

    <!-- Winner Declaration -->
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
        <div style="text-align: center; padding: 32px;">
            {% if winner %}
                <div style="font-size: 48px; margin-bottom: 16px;">üèÜ</div>
                <h2 style="margin: 0 0 8px 0; font-size: 28px;">Winner: {{ winner.username }}</h2>
                <div style="font-size: 36px; font-weight: 700; margin: 16px 0;">‚Çπ{{ difference|floatformat:2 }}</div>
                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">
                    Total: {{ better_a_total_value|floatformat:2 }} vs {{ better_b_total_value|floatformat:2 }}
                </p>
            {% else %}
                <div style="font-size: 48px; margin-bottom: 16px;">ü§ù</div>
                <h2 style="margin: 0 0 8px 0; font-size: 28px;">It's a Tie!</h2>
                <div style="font-size: 20px; margin: 16px 0; opacity: 0.9;">Both players have the same total value</div>
                <div style="font-size: 24px; font-weight: 600; margin-top: 16px;">No winner - No winnings</div>
            {% endif %}
        </div>
    </div>

    <!-- Winnings Display with Action Buttons -->
    {% if winner == user %}
    <div class="card">
        <div class="card-header">
            <h3>Your Winnings</h3>
        </div>
        <div style="text-align: center; padding: 32px;">
            <div style="font-size: 48px; font-weight: 700; color: #48bb78; margin-bottom: 16px;">
                ‚Çπ{{ difference|floatformat:2 }}
            </div>
            <p style="color: #718096; margin-bottom: 24px;">
                Congratulations! You won the match by ‚Çπ{{ difference|floatformat:2 }}.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <form method="post" action="{% url 'core:add_winnings_to_wallet' session.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #48bb78; min-width: 150px;">
                        üí∞ Add to Wallet
                    </button>
                </form>
                <form method="post" action="{% url 'core:withdraw_winnings' session.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #4299e1; min-width: 150px;">
                        üí∏ Withdraw
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% elif not winner %}
    <div class="card">
        <div class="card-header">
            <h3>Result</h3>
        </div>
        <div style="text-align: center; padding: 32px;">
            <div style="font-size: 24px; color: #718096; margin-bottom: 16px;">
                Match ended in a tie. No winnings.
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Selected Players Display - Side by Side with Stats -->
    <div class="card">
        <div class="card-header">
            <h3>Selected Players with Performance</h3>
            <p style="margin: 8px 0 0 0; color: #718096; font-size: 13px;">Both players' selections with runs and balls</p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: #4299e1;"></span>
                    {{ session.better_a.username }}
                </h4>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    {% for pick in better_a_picks %}
                        <div class="player-badge" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #ebf8ff; border-radius: 6px; border: 1px solid #4299e1;">
                            {% if pick.player.picture %}
                                <img src="{{ pick.player.picture.url }}" alt="{{ pick.player.name }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 16px;">üë§</div>
                            {% endif %}
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2c5282; margin-bottom: 4px;">{{ pick.player.name }}</div>
                                {% if pick.runs_scored is not None %}
                                    <div style="display: flex; gap: 16px; font-size: 13px; color: #4a5568;">
                                        <span>üèè <strong>{{ pick.runs_scored|default:0 }}</strong> runs</span>
                                        <span>‚öæ <strong>{{ pick.balls_faced|default:0 }}</strong> balls</span>
                                        <span style="color: #48bb78;">‚Çπ{{ pick.player_value|floatformat:2 }}</span>
                    </div>
                    {% else %}
                                    <div style="font-size: 12px; color: #718096;">Waiting for match results...</div>
                    {% endif %}
                </div>
                        </div>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px; margin: 0;">No players selected</p>
            {% endfor %}
                </div>
            </div>
                    <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #4a5568; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 8px; height: 8px; border-radius: 50%; background: #ed8936;"></span>
                    {{ session.better_b.username }}
                </h4>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    {% for pick in better_b_picks %}
                        <div class="player-badge" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff5e6; border-radius: 6px; border: 1px solid #ed8936;">
                            {% if pick.player.picture %}
                                <img src="{{ pick.player.picture.url }}" alt="{{ pick.player.name }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 16px;">üë§</div>
                            {% endif %}
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #7c2d12; margin-bottom: 4px;">{{ pick.player.name }}</div>
                                {% if pick.runs_scored is not None %}
                                    <div style="display: flex; gap: 16px; font-size: 13px; color: #4a5568;">
                                        <span>üèè <strong>{{ pick.runs_scored|default:0 }}</strong> runs</span>
                                        <span>‚öæ <strong>{{ pick.balls_faced|default:0 }}</strong> balls</span>
                                        <span style="color: #48bb78;">‚Çπ{{ pick.player_value|floatformat:2 }}</span>
                    </div>
                    {% else %}
                                    <div style="font-size: 12px; color: #718096;">Waiting for match results...</div>
                    {% endif %}
                </div>
                        </div>
                    {% empty %}
                        <p style="color: #718096; font-size: 13px; margin: 0;">No players selected</p>
            {% endfor %}
    </div>
            </div>
        </div>
    </div>

    <!-- Total Runs Comparison -->
    <div class="card">
        <div class="card-header">
            <h3>Total Runs Scored</h3>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="text-align: center; padding: 24px; background: #f7fafc; border-radius: 6px;">
                <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">{{ session.better_a.username }}</div>
                <div style="font-size: 32px; font-weight: 600; color: {% if better_a_total_runs > better_b_total_runs %}#48bb78{% else %}#4a5568{% endif %};">
                    {{ better_a_total_runs }}
                </div>
                <div style="font-size: 12px; color: #718096; margin-top: 4px;">runs</div>
            </div>
            <div style="text-align: center; padding: 24px; background: #f7fafc; border-radius: 6px;">
                <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">{{ session.better_b.username }}</div>
                <div style="font-size: 32px; font-weight: 600; color: {% if better_b_total_runs > better_a_total_runs %}#48bb78{% else %}#4a5568{% endif %};">
                    {{ better_b_total_runs }}
                </div>
                <div style="font-size: 12px; color: #718096; margin-top: 4px;">runs</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Detailed Results</h3>
            <p style="margin: 8px 0 0 0; color: #718096; font-size: 13px;">Individual player performance breakdown</p>
        </div>
        <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Runs</th>
                    <th>Balls</th>
                    <th>Value (Runs √ó ‚Çπ{{ session.fixed_bet_amount }})</th>
                </tr>
            </thead>
            <tbody>
                {% if session.better_a == user %}
                    {% for pick in better_a_picks %}
                        <tr>
                            <td><strong>{{ pick.player.name }}</strong></td>
                            <td>{{ pick.runs_scored|default:0 }}</td>
                            <td>{{ pick.balls_faced|default:0 }}</td>
                            <td style="color: #48bb78; font-weight: 600;">‚Çπ{{ pick.player_value|floatformat:2 }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #718096; padding: 20px;">No players selected</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    {% for pick in better_b_picks %}
                        <tr>
                            <td><strong>{{ pick.player.name }}</strong></td>
                            <td>{{ pick.runs_scored|default:0 }}</td>
                            <td>{{ pick.balls_faced|default:0 }}</td>
                            <td style="color: #48bb78; font-weight: 600;">‚Çπ{{ pick.player_value|floatformat:2 }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" style="text-align: center; color: #718096; padding: 20px;">No players selected</td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block extra_js %}
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Confirm</h3>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" id="confirmBtn" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
</div>

<script>
let pendingAction = null;
let pendingData = null;

function pickPlayer(playerId) {
    const playerCard = event.target.closest('.player-card');
    const playerName = playerCard.querySelector('strong').textContent;
    
    pendingAction = 'pick';
    pendingData = {player_id: playerId};
    
    document.getElementById('modalTitle').textContent = 'Select Player?';
    document.getElementById('modalBody').innerHTML = `
        <p>Do you want to pick <strong>${playerName}</strong>?</p>
        <p style="color: #718096; font-size: 13px; margin-top: 8px;">This cannot be changed later.</p>
    `;
    document.getElementById('confirmBtn').textContent = 'Yes, Pick This Player';
    document.getElementById('confirmBtn').onclick = confirmPick;
    document.getElementById('confirmModal').style.display = 'block';
}

function confirmPick() {
    if (!pendingData) return;
    
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Picking...';
    
    fetch(`{% url 'core:pick_player' session.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(pendingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #48bb78; font-size: 14px;">Player selected successfully!</p>
                <p style="color: #718096; font-size: 12px; margin-top: 8px;">${data.picked_player_name} has been picked.</p>
            `;
            confirmBtn.style.display = 'none';
            
            // Hide toss winner banner if it exists (first pick)
            const tossWinnerBanner = document.getElementById('toss-winner-banner');
            if (tossWinnerBanner) {
                tossWinnerBanner.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    tossWinnerBanner.style.display = 'none';
                }, 300);
            }
            
            // Also hide the dynamic toss result card
            const tossResultCard = document.getElementById('toss-result-card');
            if (tossResultCard) {
                tossResultCard.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    tossResultCard.style.display = 'none';
                }, 300);
            }
            
            // Update last update time
            if (data.updated_at) {
                lastUpdateTime = data.updated_at;
            }
            
            // Reload after short delay to show updated state
            setTimeout(() => {
                closeModal();
                location.reload();
            }, 800);
        } else {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #f56565;">Error: ${data.error}</p>
            `;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Close';
            confirmBtn.onclick = closeModal;
        }
    })
    .catch(error => {
        document.getElementById('modalBody').innerHTML = `
            <p style="color: #f56565;">Something went wrong. Please try again.</p>
        `;
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Close';
        confirmBtn.onclick = closeModal;
    });
}

function placeFixedBet() {
    const fixedBetAmount = {{ session.fixed_bet_amount }};
    
    pendingAction = 'bet';
    pendingData = {};
    
    document.getElementById('modalTitle').textContent = 'Place Fixed Bet?';
    document.getElementById('modalBody').innerHTML = `
        <p>Place fixed bet of <strong>‚Çπ${fixedBetAmount}</strong> per run for this session?</p>
        <p style="color: #718096; font-size: 13px; margin-top: 8px;">
            Winner gets difference of total runs scored by the players from both the team √ó ‚Çπ${fixedBetAmount}.
        </p>
    `;
    document.getElementById('confirmBtn').textContent = 'Yes, Place Bet';
    document.getElementById('confirmBtn').onclick = confirmFixedBet;
    document.getElementById('confirmBtn').disabled = false;
    document.getElementById('confirmModal').style.display = 'block';
}

function placeBet(pickedPlayerId) {
    // Legacy function - not used with fixed bet amount
    placeFixedBet();
}

function confirmFixedBet() {
    const confirmBtn = document.getElementById('confirmBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Placing Bet...';
    
    fetch(`{% url 'core:place_bet' session.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #48bb78; font-size: 14px;">${data.message}</p>
            `;
            confirmBtn.style.display = 'none';
            setTimeout(() => {
                closeModal();
                location.reload();
            }, 1000);
        } else {
            document.getElementById('modalBody').innerHTML = `
                <p style="color: #f56565;">Error: ${data.error}</p>
            `;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Close';
            confirmBtn.onclick = closeModal;
        }
    })
    .catch(error => {
        document.getElementById('modalBody').innerHTML = `
            <p style="color: #f56565;">Something went wrong. Please try again.</p>
        `;
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Close';
        confirmBtn.onclick = closeModal;
    });
}

function confirmBet() {
    // Legacy function - redirect to fixed bet
    confirmFixedBet();
}

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
    pendingData = null;
}

function confirmAction() {
    if (pendingAction === 'pick') confirmPick();
    else if (pendingAction === 'bet') confirmBet();
}

{% if session.status == 'pending' or session.status == 'picking' %}
// Toss functionality
function performToss() {
    const tossBtn = document.getElementById('toss-btn');
    if (!tossBtn) return;
    
    tossBtn.disabled = true;
    tossBtn.textContent = 'Performing Toss...';
    
    fetch(`{% url 'core:perform_toss' session.id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide toss card
            const tossCard = document.getElementById('toss-card');
            if (tossCard) {
                tossCard.style.display = 'none';
            }
            
            // Show toss result
            const tossResultCard = document.getElementById('toss-result-card');
            const tossWinnerName = document.getElementById('toss-winner-name');
            if (tossResultCard && tossWinnerName) {
                tossWinnerName.textContent = data.toss_winner;
                tossResultCard.style.display = 'block';
            }
            
            // Show notification
            if (data.is_my_turn) {
                if (typeof showNotification !== 'undefined') {
                    showNotification('You Won the Toss!', 'It\'s your turn to pick players first');
                }
                if (typeof showToast !== 'undefined') {
                    showToast('üéØ You won the toss! It\'s your turn to pick players.', 'success');
                }
                // Reload immediately on mobile, with shorter delay on desktop
                const isMobile = window.innerWidth <= 768;
                const reloadDelay = isMobile ? 500 : 1500;
                setTimeout(() => {
                    // Scroll to top before reload to ensure players list is visible
                    window.scrollTo(0, 0);
                    location.reload();
                }, reloadDelay);
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification('Toss Completed', `${data.toss_winner} won the toss and will pick first`);
                }
                if (typeof showToast !== 'undefined') {
                    showToast(`üé≤ ${data.toss_winner} won the toss. Waiting for them to pick...`, 'info');
                }
            }
            
            // Update last update time for polling
            if (data.updated_at && typeof lastUpdateTime !== 'undefined') {
                lastUpdateTime = data.updated_at;
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to perform toss'));
            tossBtn.disabled = false;
            tossBtn.textContent = 'Perform Toss';
        }
    })
    .catch(error => {
        console.error('Error performing toss:', error);
        alert('Something went wrong. Please try again.');
        tossBtn.disabled = false;
        tossBtn.textContent = 'Perform Toss';
    });
}
{% endif %}

{% if session.status == 'picking' %}
// Real-time session updates
let pollingInterval = null;
let lastUpdateTime = '{{ session.updated_at.isoformat }}';
// Track initial better_b to detect when invite is accepted
let initialBetterBUsername = '{{ session.better_b.username }}';
let initialBetterAUsername = '{{ session.better_a.username }}';
let updateCheckInProgress = false;
const turnIndicator = document.getElementById('turn-indicator');
const currentTurnUserId = {% if session.current_turn %}{{ session.current_turn.id }}{% else %}null{% endif %};
const currentUserId = {{ user.id }};

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

function showNotification(title, message) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: '/static/favicon.ico',
            tag: 'session-update',
            requireInteraction: false
        });
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? '#48bb78' : type === 'warning' ? '#ed8936' : '#4299e1';
    toast.style.cssText = `
        background: ${bgColor};
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease-out;
        cursor: pointer;
    `;
    toast.textContent = message;
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }
    `;
    if (!document.getElementById('toast-styles')) {
        style.id = 'toast-styles';
        document.head.appendChild(style);
    }
    
    toastContainer.appendChild(toast);
    
    // Auto remove after 4 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 4000);
    
    // Click to dismiss
    toast.addEventListener('click', () => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
}

function updateSelectedPlayers(data) {
    const betterAPicksList = document.getElementById('better-a-picks-list');
    const betterBPicksList = document.getElementById('better-b-picks-list');
    
    if (!betterAPicksList || !betterBPicksList) return;
    
    // Update better A picks
    const currentBetterAPicks = Array.from(betterAPicksList.querySelectorAll('[data-player-id]')).map(el => parseInt(el.dataset.playerId));
    const newBetterAPicks = data.better_a_picks.map(p => p.player_id);
    
    // Remove players that are no longer picked (shouldn't happen, but handle it)
    currentBetterAPicks.forEach(playerId => {
        if (!newBetterAPicks.includes(playerId)) {
            const badge = betterAPicksList.querySelector(`[data-player-id="${playerId}"]`);
            if (badge) {
                badge.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => badge.remove(), 300);
            }
        }
    });
    
    // Add new players for better A
    newBetterAPicks.forEach(playerId => {
        if (!currentBetterAPicks.includes(playerId)) {
            const pick = data.better_a_picks.find(p => p.player_id === playerId);
            if (pick) {
                const badge = document.createElement('div');
                badge.className = 'player-badge';
                badge.dataset.playerId = playerId;
                badge.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #ebf8ff; border-radius: 6px; border: 1px solid #4299e1; animation: fadeIn 0.3s ease-in;';
                
                // Add player avatar
                const avatar = document.createElement('div');
                avatar.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 14px;';
                avatar.textContent = 'üë§';
                badge.appendChild(avatar);
                
                // Add player name
                const name = document.createElement('span');
                name.style.cssText = 'font-weight: 500; color: #2c5282;';
                name.textContent = pick.player_name;
                badge.appendChild(name);
                
                betterAPicksList.appendChild(badge);
                
                // If list was empty, remove the empty message
                const emptyMsg = betterAPicksList.querySelector('p');
                if (emptyMsg) emptyMsg.remove();
            }
        }
    });
    
    // Update better B picks
    const currentBetterBPicks = Array.from(betterBPicksList.querySelectorAll('[data-player-id]')).map(el => parseInt(el.dataset.playerId));
    const newBetterBPicks = data.better_b_picks.map(p => p.player_id);
    
    // Remove players that are no longer picked
    currentBetterBPicks.forEach(playerId => {
        if (!newBetterBPicks.includes(playerId)) {
            const badge = betterBPicksList.querySelector(`[data-player-id="${playerId}"]`);
            if (badge) {
                badge.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => badge.remove(), 300);
            }
        }
    });
    
    // Add new players for better B
    newBetterBPicks.forEach(playerId => {
        if (!currentBetterBPicks.includes(playerId)) {
            const pick = data.better_b_picks.find(p => p.player_id === playerId);
            if (pick) {
                const badge = document.createElement('div');
                badge.className = 'player-badge';
                badge.dataset.playerId = playerId;
                badge.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #fff5e6; border-radius: 6px; border: 1px solid #ed8936; animation: fadeIn 0.3s ease-in;';
                
                // Add player avatar
                const avatar = document.createElement('div');
                avatar.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; color: #4a5568; font-size: 14px;';
                avatar.textContent = 'üë§';
                badge.appendChild(avatar);
                
                // Add player name
                const name = document.createElement('span');
                name.style.cssText = 'font-weight: 500; color: #7c2d12;';
                name.textContent = pick.player_name;
                badge.appendChild(name);
                
                betterBPicksList.appendChild(badge);
                
                // If list was empty, remove the empty message
                const emptyMsg = betterBPicksList.querySelector('p');
                if (emptyMsg) emptyMsg.remove();
            }
        }
    });
    
    // If both lists are empty, add empty messages
    if (betterAPicksList.querySelectorAll('[data-player-id]').length === 0 && !betterAPicksList.querySelector('p')) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.cssText = 'color: #718096; font-size: 13px;';
        emptyMsg.textContent = 'No players selected yet';
        betterAPicksList.appendChild(emptyMsg);
    }
    if (betterBPicksList.querySelectorAll('[data-player-id]').length === 0 && !betterBPicksList.querySelector('p')) {
        const emptyMsg = document.createElement('p');
        emptyMsg.style.cssText = 'color: #718096; font-size: 13px;';
        emptyMsg.textContent = 'No players selected yet';
        betterBPicksList.appendChild(emptyMsg);
    }
}

function updateProgress(data) {
    const isBetterA = {{ session.better_a.id }} === currentUserId;
    
    // Update team counts
    if (isBetterA) {
        document.getElementById('team-a-progress').textContent = `${data.better_a_team_a_count}/{{ session.players_per_side }}`;
        document.getElementById('team-b-progress').textContent = `${data.better_a_team_b_count}/{{ session.players_per_side }}`;
        document.getElementById('total-picked').textContent = data.better_a_picks_count;
    } else {
        document.getElementById('team-a-progress').textContent = `${data.better_b_team_a_count}/{{ session.players_per_side }}`;
        document.getElementById('team-b-progress').textContent = `${data.better_b_team_b_count}/{{ session.players_per_side }}`;
        document.getElementById('total-picked').textContent = data.better_b_picks_count;
    }
    
    // Add pulse animation when count changes
    const teamAProgress = document.getElementById('team-a-progress');
    const teamBProgress = document.getElementById('team-b-progress');
    teamAProgress.style.transform = 'scale(1.1)';
    teamBProgress.style.transform = 'scale(1.1)';
    setTimeout(() => {
        teamAProgress.style.transform = 'scale(1)';
        teamBProgress.style.transform = 'scale(1)';
    }, 300);
}

function removePickedPlayersFromAvailable(data) {
    // Get all picked player IDs
    const allPickedIds = new Set();
    data.better_a_picks.forEach(p => allPickedIds.add(p.player_id));
    data.better_b_picks.forEach(p => allPickedIds.add(p.player_id));
    
    // Remove from team A list
    const teamAList = document.getElementById('team-a-players-list');
    if (teamAList) {
        const teamACards = teamAList.querySelectorAll('.player-card[data-player-id]');
        teamACards.forEach(card => {
            const playerId = parseInt(card.dataset.playerId);
            if (allPickedIds.has(playerId)) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.remove();
                    // Check if list is empty
                    if (teamAList.querySelectorAll('.player-card').length === 0) {
                        const emptyMsg = document.createElement('p');
                        emptyMsg.style.cssText = 'text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;';
                        emptyMsg.textContent = 'No more players available from this team';
                        teamAList.appendChild(emptyMsg);
                    }
                }, 300);
            }
        });
    }
    
    // Remove from team B list
    const teamBList = document.getElementById('team-b-players-list');
    if (teamBList) {
        const teamBCards = teamBList.querySelectorAll('.player-card[data-player-id]');
        teamBCards.forEach(card => {
            const playerId = parseInt(card.dataset.playerId);
            if (allPickedIds.has(playerId)) {
                card.style.animation = 'fadeOut 0.3s ease-out';
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.remove();
                    // Check if list is empty
                    if (teamBList.querySelectorAll('.player-card').length === 0) {
                        const emptyMsg = document.createElement('p');
                        emptyMsg.style.cssText = 'text-align: center; color: #718096; padding: 20px; grid-column: 1 / -1;';
                        emptyMsg.textContent = 'No more players available from this team';
                        teamBList.appendChild(emptyMsg);
                    }
                }, 300);
            }
        });
    }
}

function updateSessionState(data) {
    // Detect when invite is accepted (better_b changes from better_a to a different user)
    if (initialBetterBUsername === initialBetterAUsername && 
        data.better_b_username && 
        data.better_b_username !== initialBetterAUsername) {
        // Invite was just accepted!
        showNotification('Player Joined!', `${data.better_b_username} has joined the session!`);
        showToast(`üéâ ${data.better_b_username} has joined the session!`, 'success');
        
        // Update initial state
        initialBetterBUsername = data.better_b_username;
        
        // Reload page to show player list and allow picking
        setTimeout(() => {
            location.reload();
        }, 1500);
        return; // Don't process other updates, we're reloading
    }
    
    // Hide toss winner banner if first player has been picked
    if (data.better_a_picks_count > 0 || data.better_b_picks_count > 0) {
        const tossWinnerBanner = document.getElementById('toss-winner-banner');
        if (tossWinnerBanner && tossWinnerBanner.style.display !== 'none') {
            tossWinnerBanner.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                tossWinnerBanner.style.display = 'none';
            }, 300);
        }
        
        // Also hide the dynamic toss result card
        const tossResultCard = document.getElementById('toss-result-card');
        if (tossResultCard && tossResultCard.style.display !== 'none') {
            tossResultCard.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                tossResultCard.style.display = 'none';
            }, 300);
        }
    }
    
    // Update turn indicator
    if (turnIndicator) {
        const isMyTurn = data.is_my_turn;
        const currentTurnUsername = data.current_turn || 'Waiting...';
        
        if (isMyTurn) {
            turnIndicator.innerHTML = `
                <div style="background: #ebf8ff; padding: 16px; border-radius: 6px; border-left: 4px solid #4299e1;">
                    <h3 style="margin: 0 0 8px 0; color: #2c5282;">Your Turn</h3>
                    <p style="margin: 0; color: #2c5282;">Select a player from either team below. You need to pick {{ session.players_per_side }} players from each team.</p>
                </div>
            `;
            
            // Show notification if it just became your turn
            if (turnIndicator.dataset.isMyTurn !== 'true') {
                showNotification('Your Turn!', 'It\'s your turn to pick a player');
                showToast('üéØ It\'s your turn to pick a player!', 'success');
            }
        } else {
            turnIndicator.innerHTML = `
                <div style="background: #fffaf0; padding: 16px; border-radius: 6px; border-left: 4px solid #ed8936;">
                    <h3 style="margin: 0 0 8px 0; color: #7c2d12;">Waiting</h3>
                    <p style="margin: 0; color: #7c2d12;">Waiting for <strong>${currentTurnUsername}</strong> to pick a player. This page will update automatically.</p>
                </div>
            `;
        }
        turnIndicator.dataset.isMyTurn = isMyTurn;
    }
    
    // Update selected players list smoothly (always update, not just when it's your turn)
    if (typeof updateSelectedPlayers !== 'undefined') {
        updateSelectedPlayers(data);
    }
    
    // Update progress counters
    if (typeof updateProgress !== 'undefined') {
        updateProgress(data);
    }
    
    // Remove picked players from available list (if it's your turn)
    if (data.is_my_turn && typeof removePickedPlayersFromAvailable !== 'undefined') {
        removePickedPlayersFromAvailable(data);
    }
    
    // Show notification for opponent's picks and reload page
    let opponentPicked = false;
    if (data.recent_picks && data.recent_picks.length > 0) {
        data.recent_picks.forEach(pick => {
            if (pick.is_opponent && pick.picked_at > lastUpdateTime) {
                opponentPicked = true;
                const message = `${pick.better_username} picked ${pick.player_name}`;
                showNotification('Player Picked!', message);
                showToast(`üë§ ${message}`, 'info');
            }
        });
    }
    
    // Update last update time
    lastUpdateTime = data.updated_at;
    
    // Reload page if opponent picked a player (to show updated available players list)
    // or if status changed or picks completed
    if (opponentPicked || data.status !== '{{ session.status }}' || data.picks_completed) {
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

function checkForUpdates() {
    if (updateCheckInProgress || document.visibilityState !== 'visible') {
        return;
    }
    
    updateCheckInProgress = true;
    
    fetch(`{% url 'core:check_session_updates' session.id %}?last_update=${encodeURIComponent(lastUpdateTime)}`, {
        headers: {
            'Cache-Control': 'no-cache',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        updateCheckInProgress = false;
        
        if (data.session_updated) {
            // Check if toss was just completed
            if (data.toss_completed && data.status === 'picking') {
                // Hide toss card if visible
                const tossCard = document.getElementById('toss-card');
                if (tossCard) {
                    tossCard.style.display = 'none';
                }
                
                // Show toss result
                const tossResultCard = document.getElementById('toss-result-card');
                const tossWinnerName = document.getElementById('toss-winner-name');
                if (tossResultCard && tossWinnerName && data.toss_winner) {
                    tossWinnerName.textContent = data.toss_winner;
                    tossResultCard.style.display = 'block';
                }
                
                // Show notification
                if (data.is_my_turn) {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Toss Completed!', 'You won the toss! It\'s your turn to pick players.');
                    }
                    if (typeof showToast !== 'undefined') {
                        showToast('üéØ You won the toss! It\'s your turn to pick players.', 'success');
                    }
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                    return;
                } else {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Toss Completed', `${data.toss_winner} won the toss and will pick first`);
                    }
                    if (typeof showToast !== 'undefined') {
                        showToast(`üé≤ ${data.toss_winner} won the toss. Waiting for them to pick...`, 'info');
                    }
                }
            }
            
            if (typeof updateSessionState !== 'undefined') {
                updateSessionState(data);
            }
            
            // If it's now my turn, reload to show player selection
            if (data.is_my_turn && turnIndicator && turnIndicator.dataset.isMyTurn !== 'true') {
                // Small delay to show the notification first
                setTimeout(() => {
                    location.reload();
                }, 800);
            }
        }
    })
    .catch(error => {
        updateCheckInProgress = false;
        console.error('Error checking for updates:', error);
    });
}

// Start polling when page is visible (for pending and picking status)
if (turnIndicator || document.getElementById('toss-card')) {
    // Check immediately
    if (typeof checkForUpdates !== 'undefined') {
        checkForUpdates();
    }
    
    // Poll every 1.5 seconds for very responsive updates
    pollingInterval = setInterval(() => {
        if (typeof checkForUpdates !== 'undefined') {
            checkForUpdates();
        }
    }, 1500);
    
    // Also check when page becomes visible
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && typeof checkForUpdates !== 'undefined') {
            checkForUpdates();
        }
    });
}

// Poll for toss completion when status is pending
{% if session.status == 'pending' %}
const tossCard = document.getElementById('toss-card');
if (tossCard && (tossCard.style.display !== 'none')) {
    // Initialize lastUpdateTime if not already set
    if (typeof lastUpdateTime === 'undefined') {
        lastUpdateTime = '{{ session.updated_at.isoformat }}';
    }
    
    // Toss not completed yet, poll for updates
    let tossPollingInterval = setInterval(() => {
        if (document.visibilityState !== 'visible') return;
        
        fetch(`{% url 'core:check_session_updates' session.id %}?last_update=${encodeURIComponent(lastUpdateTime || '')}`, {
            headers: {
                'Cache-Control': 'no-cache',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.toss_completed && data.status === 'picking') {
                clearInterval(tossPollingInterval);
                
                // Hide toss card
                if (tossCard) {
                    tossCard.style.display = 'none';
                }
                
                // Show toss result
                const tossResultCard = document.getElementById('toss-result-card');
                const tossWinnerName = document.getElementById('toss-winner-name');
                if (tossResultCard && tossWinnerName) {
                    tossWinnerName.textContent = data.toss_winner;
                    tossResultCard.style.display = 'block';
                }
                
                // Show notification
                if (data.is_my_turn) {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Toss Completed!', 'You won the toss! It\'s your turn to pick players.');
                    }
                    if (typeof showToast !== 'undefined') {
                        showToast('üéØ You won the toss! It\'s your turn to pick players.', 'success');
                    }
                    // Reload immediately on mobile, with shorter delay on desktop
                    const isMobile = window.innerWidth <= 768;
                    const reloadDelay = isMobile ? 500 : 1500;
                    setTimeout(() => {
                        // Scroll to top before reload to ensure players list is visible
                        window.scrollTo(0, 0);
                        location.reload();
                    }, reloadDelay);
                } else {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Toss Completed', `${data.toss_winner} won the toss and will pick first`);
                    }
                    if (typeof showToast !== 'undefined') {
                        showToast(`üé≤ ${data.toss_winner} won the toss. Waiting for them to pick...`, 'info');
                    }
                }
            }
        })
        .catch(() => {});
    }, 2000);
}
{% endif %}

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});
{% endif %}

// Modal functions for Current Standings
function openStandingsModal() {
    const modal = document.getElementById('standingsModal');
    const scrollArea = document.getElementById('standingsModalScrollArea');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    // Reset scroll position when opening
    if (scrollArea) {
        scrollArea.scrollTop = 0;
    }
}

function closeStandingsModal() {
    const modal = document.getElementById('standingsModal');
    const scrollArea = document.getElementById('standingsModalScrollArea');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    // Reset scroll position when closing
    if (scrollArea) {
        scrollArea.scrollTop = 0;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('standingsModal');
    if (event.target == modal) {
        closeStandingsModal();
    }
}
</script>

<!-- Current Standings Modal -->
{% if session.match.status == 'live' %}
<div id="standingsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; animation: fadeIn 0.3s ease-in; padding: 10px; box-sizing: border-box; overflow: hidden;">
    <div id="standingsModalContent" style="background: white; border-radius: 12px; padding: 0; max-width: 600px; width: 100%; max-height: 90vh; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease-out; position: relative; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;">
        <!-- Modal Header -->
        <div style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white; padding: 16px 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; position: relative; min-height: 60px; box-sizing: border-box; flex-shrink: 0;">
            <div style="flex: 1; min-width: 0; padding-right: 12px;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 700; line-height: 1.2;">‚ö° Current Standings</h2>
                <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 12px; line-height: 1.3;">Live match progress</p>
            </div>
            <button onclick="closeStandingsModal()" id="standingsModalCloseBtn" style="background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; font-size: 28px; width: 40px; height: 40px; min-width: 40px; min-height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; line-height: 1; padding: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" onmouseover="this.style.background='rgba(255,255,255,0.4)'; this.style.borderColor='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'; this.style.borderColor='rgba(255,255,255,0.5)'" ontouchstart="this.style.background='rgba(255,255,255,0.4)'" ontouchend="this.style.background='rgba(255,255,255,0.25)'">&times;</button>
        </div>
        
        <!-- Modal Content - Scrollable Area -->
        <div id="standingsModalScrollArea" style="padding: 32px; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; flex: 1; min-height: 0;">
            {% if better_a_bets.exists and better_b_bets.exists %}
            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                <!-- Better A Summary -->
                <div style="padding: 24px; background: {% if current_leader == session.better_a %}#f0fff4{% else %}#f7fafc{% endif %}; border-radius: 8px; border: 2px solid {% if current_leader == session.better_a %}#48bb78{% else %}#4299e1{% endif %}; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #4299e1; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">A</div>
                        <div>
                            <div style="font-size: 14px; color: #718096; margin-bottom: 4px;">Player</div>
                            <div style="font-size: 18px; font-weight: 600; color: #2c5282;">{{ session.better_a.username }}</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Total Runs</div>
                        <div style="font-size: 32px; font-weight: 700; color: #2c5282;">{{ better_a_total_runs }}</div>
                    </div>
                    {% if session.fixed_bet_amount %}
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Current Value</div>
                        <div style="font-size: 20px; font-weight: 600; color: #4299e1;">‚Çπ{{ better_a_total_value|floatformat:2 }}</div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Better B Summary -->
                <div style="padding: 24px; background: {% if current_leader == session.better_b %}#f0fff4{% else %}#fffaf0{% endif %}; border-radius: 8px; border: 2px solid {% if current_leader == session.better_b %}#48bb78{% else %}#ed8936{% endif %}; transition: all 0.3s;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #ed8936; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 18px;">B</div>
                        <div>
                            <div style="font-size: 14px; color: #718096; margin-bottom: 4px;">Player</div>
                            <div style="font-size: 18px; font-weight: 600; color: #7c2d12;">{{ session.better_b.username }}</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 6px; margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Total Runs</div>
                        <div style="font-size: 32px; font-weight: 700; color: #7c2d12;">{{ better_b_total_runs }}</div>
                    </div>
                    {% if session.fixed_bet_amount %}
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 4px;">Current Value</div>
                        <div style="font-size: 20px; font-weight: 600; color: #ed8936;">‚Çπ{{ better_b_total_value|floatformat:2 }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Player Breakdown -->
            <div style="margin-bottom: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #2d3748; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0;">üìä Player Performance Breakdown</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Better A Players -->
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #4299e1; margin-bottom: 12px; padding: 8px; background: #ebf8ff; border-radius: 6px;">
                            {{ session.better_a.username }}'s Players
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            {% for pick in better_a_picks %}
                            <div style="padding: 12px; background: {% if pick.is_active %}#e6fffa{% elif pick.has_batted %}#f7fafc{% else %}#fef5e7{% endif %}; border-radius: 6px; border-left: 3px solid {% if pick.is_active %}#48bb78{% elif pick.has_batted %}#4299e1{% else %}#ed8936{% endif %};">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #2c5282;">{{ pick.player.name }}</div>
                                    {% if pick.is_active %}
                                    <span style="padding: 2px 6px; background: #48bb78; color: white; border-radius: 4px; font-size: 10px; font-weight: 600;">‚ö° Playing</span>
                                    {% endif %}
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #4a5568;">
                                    {% if pick.has_batted %}
                                        <span>üèè <strong>{{ pick.runs_scored|default:0 }}</strong> runs</span>
                                        <span>‚öæ <strong>{{ pick.balls_faced|default:0 }}</strong> balls</span>
                                        {% if session.fixed_bet_amount %}
                                        <span style="color: #4299e1; font-weight: 600;">‚Çπ{{ pick.player_value|floatformat:2 }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #ed8936; font-weight: 600; font-style: italic;">‚è≥ Yet to Bat</span>
                                        {% if session.fixed_bet_amount %}
                                        <span style="color: #718096;">‚Çπ0.00</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <div style="padding: 12px; text-align: center; color: #718096; font-size: 13px;">No players selected</div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Better B Players -->
                    <div>
                        <div style="font-size: 14px; font-weight: 600; color: #ed8936; margin-bottom: 12px; padding: 8px; background: #fff5e6; border-radius: 6px;">
                            {{ session.better_b.username }}'s Players
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            {% for pick in better_b_picks %}
                            <div style="padding: 12px; background: {% if pick.is_active %}#e6fffa{% elif pick.has_batted %}#fffaf0{% else %}#fef5e7{% endif %}; border-radius: 6px; border-left: 3px solid {% if pick.is_active %}#48bb78{% elif pick.has_batted %}#ed8936{% else %}#ed8936{% endif %};">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #7c2d12;">{{ pick.player.name }}</div>
                                    {% if pick.is_active %}
                                    <span style="padding: 2px 6px; background: #48bb78; color: white; border-radius: 4px; font-size: 10px; font-weight: 600;">‚ö° Playing</span>
                                    {% endif %}
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #4a5568;">
                                    {% if pick.has_batted %}
                                        <span>üèè <strong>{{ pick.runs_scored|default:0 }}</strong> runs</span>
                                        <span>‚öæ <strong>{{ pick.balls_faced|default:0 }}</strong> balls</span>
                                        {% if session.fixed_bet_amount %}
                                        <span style="color: #ed8936; font-weight: 600;">‚Çπ{{ pick.player_value|floatformat:2 }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color: #ed8936; font-weight: 600; font-style: italic;">‚è≥ Yet to Bat</span>
                                        {% if session.fixed_bet_amount %}
                                        <span style="color: #718096;">‚Çπ0.00</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <div style="padding: 12px; text-align: center; color: #718096; font-size: 13px;">No players selected</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calculation Breakdown -->
            {% if session.fixed_bet_amount %}
            <div style="padding: 20px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 16px;">üßÆ How Current Standings is Calculated</h3>
                <div style="display: flex; flex-direction: column; gap: 12px; font-size: 14px; color: #4a5568;">
                    <div style="padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-weight: 600; color: #2c5282; margin-bottom: 8px;">{{ session.better_a.username }}:</div>
                        <div style="padding-left: 12px;">
                            <div>Total Runs: <strong>{{ better_a_total_runs }}</strong></div>
                            <div>Calculation: <strong>{{ better_a_total_runs }}</strong> runs √ó ‚Çπ{{ session.fixed_bet_amount }} = <strong style="color: #4299e1;">‚Çπ{{ better_a_total_value|floatformat:2 }}</strong></div>
                        </div>
                    </div>
                    <div style="padding: 12px; background: white; border-radius: 6px;">
                        <div style="font-weight: 600; color: #7c2d12; margin-bottom: 8px;">{{ session.better_b.username }}:</div>
                        <div style="padding-left: 12px;">
                            <div>Total Runs: <strong>{{ better_b_total_runs }}</strong></div>
                            <div>Calculation: <strong>{{ better_b_total_runs }}</strong> runs √ó ‚Çπ{{ session.fixed_bet_amount }} = <strong style="color: #ed8936;">‚Çπ{{ better_b_total_value|floatformat:2 }}</strong></div>
                        </div>
                    </div>
                    {% if difference > 0 %}
                    <div style="padding: 12px; background: #ebf8ff; border-radius: 6px; border-left: 4px solid #4299e1;">
                        <div style="font-weight: 600; color: #2c5282; margin-bottom: 4px;">Current Difference:</div>
                        <div>|‚Çπ{{ better_a_total_value|floatformat:2 }} - ‚Çπ{{ better_b_total_value|floatformat:2 }}| = <strong style="color: #4299e1; font-size: 16px;">‚Çπ{{ difference|floatformat:2 }}</strong></div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Detailed Difference Breakdown -->
            {% if difference > 0 %}
            <div style="padding: 24px; background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%); border-radius: 12px; border: 2px solid #4299e1; margin-top: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 16px; color: #2c5282; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Current Lead</div>
                    <div style="font-size: 42px; font-weight: 700; color: #4299e1; text-shadow: 0 2px 4px rgba(66, 153, 225, 0.2);">
                        ‚Çπ{{ difference|floatformat:2 }}
                    </div>
                    <div style="font-size: 14px; color: #4a5568; margin-top: 8px;">
                        {% if current_leader == session.better_a %}
                            {{ session.better_a.username }} is ahead by ‚Çπ{{ difference|floatformat:2 }}
                        {% else %}
                            {{ session.better_b.username }} is ahead by ‚Çπ{{ difference|floatformat:2 }}
                        {% endif %}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding-top: 20px; border-top: 2px solid rgba(66, 153, 225, 0.3);">
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 2px solid {% if current_leader == session.better_a %}#48bb78{% else %}#4299e1{% endif %};">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 6px; font-weight: 600;">{{ session.better_a.username }}</div>
                        <div style="font-size: 24px; font-weight: 700; color: {% if current_leader == session.better_a %}#48bb78{% else %}#4299e1{% endif %};">
                            ‚Çπ{{ better_a_total_value|floatformat:2 }}
                        </div>
                        <div style="font-size: 11px; color: #4a5568; margin-top: 4px;">{{ better_a_total_runs }} runs</div>
                    </div>
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 2px solid {% if current_leader == session.better_b %}#48bb78{% else %}#ed8936{% endif %};">
                        <div style="font-size: 12px; color: #718096; margin-bottom: 6px; font-weight: 600;">{{ session.better_b.username }}</div>
                        <div style="font-size: 24px; font-weight: 700; color: {% if current_leader == session.better_b %}#48bb78{% else %}#ed8936{% endif %};">
                            ‚Çπ{{ better_b_total_value|floatformat:2 }}
                        </div>
                        <div style="font-size: 11px; color: #4a5568; margin-top: 4px;">{{ better_b_total_runs }} runs</div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div style="text-align: center; padding: 40px; color: #718096;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                <p style="font-size: 16px; margin: 0;">Waiting for both players to place their bets to view standings.</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Modal Footer -->
        <div style="padding: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
            <button onclick="closeStandingsModal()" style="background: #4299e1; color: white; border: none; padding: 12px 32px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 16px; transition: background 0.2s;" onmouseover="this.style.background='#3182ce'" onmouseout="this.style.background='#4299e1'">Close</button>
        </div>
    </div>
</div>

<style>
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        transform: translateY(50px);
        opacity: 0;
    }
    to { 
        transform: translateY(0);
        opacity: 1;
    }
}

/* Responsive styles for session detail page */
@media (max-width: 768px) {
    /* Ensure players list is visible and properly displayed on mobile */
    .player-list {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
        gap: 12px !important;
        margin-top: 16px !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .player-card {
        min-height: 120px !important;
        padding: 12px !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    /* Ensure cards containing players list are visible */
    .card .player-list {
        display: grid !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure player cards are visible */
    #team-a-players-list,
    #team-b-players-list {
        display: grid !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Modal responsive */
    #standingsModal {
        padding: 8px !important;
        align-items: flex-start !important;
        padding-top: 20px !important;
        overflow: hidden !important;
    }
    
    #standingsModalContent {
        width: calc(100% - 16px) !important;
        max-width: calc(100% - 16px) !important;
        margin: 0 auto !important;
        max-height: calc(100vh - 40px) !important;
        height: calc(100vh - 40px) !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }
    
    /* Ensure scrollable area works on mobile */
    #standingsModalScrollArea {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        flex: 1 !important;
        min-height: 0 !important;
        overscroll-behavior: contain !important;
    }
    
    #standingsModal .card-header h2 {
        font-size: 20px !important;
    }
    
    #standingsModal .card-header p {
        font-size: 12px !important;
    }
    
    /* Grid layouts - stack on mobile */
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }
    
    /* Player selection grid */
    #better-a-picks-list,
    #better-b-picks-list {
        flex-direction: column !important;
    }
    
    /* Selected players side by side - stack on mobile */
    div[style*="display: grid"][style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    /* Card padding reduction */
    .card {
        padding: 16px !important;
    }
    
    /* Button sizes for touch */
    .btn {
        padding: 12px 20px !important;
        font-size: 16px !important;
        min-height: 44px !important;
    }
    
    /* Modal content padding */
    #standingsModal > div > div[style*="padding: 32px"] {
        padding: 20px !important;
    }
    
    /* Player cards in modal */
    #standingsModal div[style*="padding: 24px"] {
        padding: 16px !important;
    }
    
    /* Font sizes in modal */
    #standingsModal div[style*="font-size: 32px"] {
        font-size: 24px !important;
    }
    
    #standingsModal div[style*="font-size: 36px"] {
        font-size: 28px !important;
    }
    
    #standingsModal div[style*="font-size: 20px"] {
        font-size: 16px !important;
    }
    
    /* Player breakdown grid - stack on mobile */
    #standingsModal div[style*="grid-template-columns: 1fr 1fr"][style*="gap: 20px"] {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }
    
    /* Player performance breakdown */
    #standingsModal h3 {
        font-size: 16px !important;
    }
    
    /* Player breakdown cards */
    #standingsModal div[style*="padding: 12px"][style*="background: #f7fafc"] {
        padding: 10px !important;
        font-size: 12px !important;
    }
    
    /* Calculation breakdown */
    #standingsModal div[style*="padding: 20px"][style*="background: #f7fafc"] {
        padding: 16px !important;
    }
    
    /* Close button in modal header - ensure visibility on mobile */
    #standingsModalCloseBtn {
        width: 44px !important;
        height: 44px !important;
        min-width: 44px !important;
        min-height: 44px !important;
        font-size: 32px !important;
        background: rgba(255,255,255,0.3) !important;
        border: 2px solid rgba(255,255,255,0.6) !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        z-index: 10 !important;
        position: relative !important;
    }
    
    /* Modal header adjustments for mobile */
    #standingsModal > div > div[style*="border-radius: 12px 12px 0 0"] {
        padding: 14px 16px !important;
        min-height: 56px !important;
    }
    
    #standingsModal > div > div[style*="border-radius: 12px 12px 0 0"] h2 {
        font-size: 18px !important;
    }
    
    #standingsModal > div > div[style*="border-radius: 12px 12px 0 0"] p {
        font-size: 11px !important;
        margin-top: 2px !important;
    }
    
    /* Toast notifications */
    #toast-container {
        right: 10px !important;
        left: 10px !important;
        max-width: calc(100% - 20px) !important;
    }
    
    /* Page header */
    .page-header h1 {
        font-size: 24px !important;
    }
    
    /* Match info card */
    .card > div[style*="display: flex"] {
        flex-direction: column !important;
        align-items: flex-start !important;
    }
    
    /* Progress counters */
    div[style*="display: flex"][style*="gap: 16px"] {
        flex-wrap: wrap !important;
        gap: 8px !important;
    }
    
    /* Form inputs */
    .form-control {
        font-size: 16px !important; /* Prevents zoom on iOS */
    }
    
    /* Table wrapper */
    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Player badges */
    .player-badge {
        width: 100% !important;
        max-width: 100% !important;
    }
}

@media (max-width: 480px) {
    /* Extra small screens */
    #standingsModal {
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    #standingsModalContent {
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 0 !important;
        margin: 0 !important;
        max-height: 100vh !important;
        height: 100vh !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }
    
    /* Ensure scrollable area works on small mobile */
    #standingsModalScrollArea {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        flex: 1 !important;
        min-height: 0 !important;
        overscroll-behavior: contain !important;
        padding: 20px !important;
    }
    
    #standingsModal > div > div[style*="border-radius: 12px 12px 0 0"] {
        border-radius: 0 !important;
        padding: 12px 14px !important;
        min-height: 52px !important;
    }
    
    /* Close button on extra small screens */
    #standingsModalCloseBtn {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        font-size: 28px !important;
    }
    
    #standingsModal > div > div[style*="border-radius: 12px 12px 0 0"] h2 {
        font-size: 16px !important;
    }
    
    #standingsModal > div > div[style*="border-radius: 12px 12px 0 0"] p {
        font-size: 10px !important;
    }
    
    .container {
        padding: 12px !important;
    }
    
    .card {
        padding: 12px !important;
        margin-bottom: 16px !important;
    }
    
    /* Modal header on very small screens */
    #standingsModal > div > div[style*="padding: 32px"] {
        padding: 16px !important;
    }
    
    #standingsModal .card-header h2 {
        font-size: 18px !important;
    }
}

/* Landscape orientation adjustments */
@media (max-width: 768px) and (orientation: landscape) {
    #standingsModal > div {
        max-height: 90vh !important;
    }
    
    #standingsModal > div > div[style*="padding: 32px"] {
        padding: 16px !important;
    }
}
</style>
{% endif %}
{% endblock %}
